# sfda_nexus 企業 AI 聊天系統開發計劃

## 📋 項目概述

**項目名稱**: sfda_nexus  
**項目類型**: 企業內部 AI 聊天系統  
**開發模式**: 統一管理，用戶使用  
**技術棧**: Vue 3 + Ant Design + Node.js + Express + MySQL

---

## 🎯 系統定位

- 🏢 **企業內部 AI 服務平台**
- 👥 **管理員統一配置，員工直接使用**
- 🤖 **預設智能體角色，標準化服務**
- 📋 **工作流程自動化**
- 🔒 **權限控制與審計**

---

## 🏗️ 技術架構

### **前端技術棧**

- **框架**: Vue 3 (Composition API)
- **UI 庫**: Ant Design Vue 4.x
- **狀態管理**: Pinia
- **路由**: Vue Router 4
- **HTTP 客戶端**: Axios
- **實時通信**: WebSocket
- **語言**: 純 JavaScript

### **後端技術棧**

- **框架**: Node.js + Express.js
- **資料庫**: MySQL 8.0
- **ORM**: 原生 SQL (mysql2)
- **認證**: JWT
- **檔案上傳**: Multer
- **API 文檔**: Swagger
- **實時通信**: WebSocket (ws)
- **語言**: 純 JavaScript

### **AI 整合**

- **本地模型**: Ollama (主要)
- **雲端服務**: Google Gemini (輔助)
- **向量資料庫**: Qdrant (知識庫)
- **工具協議**: MCP (Model Context Protocol)

---

## 📁 前端目錄結構

```
frontend/
├── public/
│   ├── index.html
│   └── favicon.ico
├── src/
│   ├── views/                          # 頁面視圖
│   │   ├── auth/                       # 認證相關頁面
│   │   │   ├── index.vue              # 登入頁面
│   │   │   └── components/
│   │   │       ├── LoginForm.vue
│   │   │       └── RegisterForm.vue
│   │   ├── chat/                       # 聊天功能
│   │   │   ├── index.vue              # 主聊天頁面
│   │   │   ├── history.vue            # 對話歷史
│   │   │   └── components/
│   │   │       ├── ChatWindow.vue     # 聊天視窗
│   │   │       ├── MessageItem.vue    # 訊息項目
│   │   │       ├── FileUpload.vue     # 檔案上傳
│   │   │       ├── ModelSelector.vue  # 模型選擇器
│   │   │       ├── AgentSelector.vue  # 智能體選擇器
│   │   │       └── PromptTemplates.vue # 命令詞模板
│   │   ├── admin/                      # 管理功能
│   │   │   ├── dashboard.vue          # 管理儀表板
│   │   │   ├── models/                # 模型管理
│   │   │   │   ├── index.vue
│   │   │   │   └── components/
│   │   │   │       ├── ModelList.vue
│   │   │   │       ├── ModelForm.vue
│   │   │   │       └── ModelTest.vue
│   │   │   ├── agents/                # 智能體管理
│   │   │   │   ├── index.vue
│   │   │   │   └── components/
│   │   │   │       ├── AgentList.vue
│   │   │   │       ├── AgentForm.vue
│   │   │   │       └── AgentPreview.vue
│   │   │   ├── workflows/             # 工作流管理
│   │   │   │   ├── index.vue
│   │   │   │   └── components/
│   │   │   │       ├── WorkflowList.vue
│   │   │   │       ├── WorkflowDesigner.vue
│   │   │   │       └── ExecutionLog.vue
│   │   │   ├── users/                 # 用戶管理
│   │   │   │   ├── index.vue
│   │   │   │   └── components/
│   │   │   │       ├── UserList.vue
│   │   │   │       └── UserForm.vue
│   │   │   └── system/                # 系統監控
│   │   │       ├── index.vue
│   │   │       └── components/
│   │   │           ├── SystemStats.vue
│   │   │           ├── UsageChart.vue
│   │   │           └── AuditLog.vue
│   │   └── user/                       # 用戶個人功能
│   │       ├── profile.vue            # 個人資料
│   │       └── components/
│   │           └── ProfileForm.vue
│   ├── components/                     # 共用組件
│   │   ├── layout/
│   │   │   ├── AppLayout.vue          # 主佈局
│   │   │   ├── Sidebar.vue            # 側邊欄
│   │   │   ├── Header.vue             # 頂部導航
│   │   │   └── Footer.vue             # 底部
│   │   ├── common/
│   │   │   ├── Loading.vue            # 載入組件
│   │   │   ├── Empty.vue              # 空狀態
│   │   │   ├── ErrorBoundary.vue      # 錯誤邊界
│   │   │   └── ConfirmDialog.vue      # 確認對話框
│   │   └── ui/
│   │       ├── IconButton.vue         # 圖標按鈕
│   │       ├── StatusTag.vue          # 狀態標籤
│   │       └── DataTable.vue          # 數據表格
│   ├── stores/                         # 狀態管理
│   │   ├── auth.js                    # 認證狀態
│   │   ├── chat.js                    # 聊天狀態
│   │   ├── models.js                  # 模型狀態
│   │   ├── agents.js                  # 智能體狀態
│   │   ├── workflows.js               # 工作流狀態
│   │   └── app.js                     # 應用全局狀態
│   ├── utils/                          # 工具函數
│   │   ├── api.js                     # API 調用
│   │   ├── websocket.js               # WebSocket 連接
│   │   ├── auth.js                    # 認證工具
│   │   ├── format.js                  # 格式化工具
│   │   ├── validation.js              # 驗證工具
│   │   └── constants.js               # 常量定義
│   ├── router/                         # 路由配置
│   │   └── index.js
│   ├── styles/                         # 樣式文件
│   │   ├── main.css
│   │   ├── variables.css
│   │   └── components.css
│   ├── App.vue                        # 根組件
│   └── main.js                        # 入口文件
├── package.json
├── vite.config.js
└── README.md
```

---

## 📁 後端目錄結構

```
backend/
├── src/
│   ├── controllers/                    # 控制器層
│   │   ├── authController.js          # 認證控制器
│   │   ├── chatController.js          # 聊天控制器
│   │   ├── modelController.js         # 模型控制器
│   │   ├── agentController.js         # 智能體控制器
│   │   ├── workflowController.js      # 工作流控制器
│   │   ├── userController.js          # 用戶控制器
│   │   ├── toolController.js          # 工具控制器
│   │   └── adminController.js         # 管理控制器
│   ├── routes/                         # 路由層
│   │   ├── auth.js                    # 認證路由 + Swagger
│   │   ├── chat.js                    # 聊天路由 + Swagger
│   │   ├── models.js                  # 模型路由 + Swagger
│   │   ├── agents.js                  # 智能體路由 + Swagger
│   │   ├── workflows.js               # 工作流路由 + Swagger
│   │   ├── users.js                   # 用戶路由 + Swagger
│   │   ├── tools.js                   # 工具路由 + Swagger
│   │   ├── admin.js                   # 管理路由 + Swagger
│   │   └── index.js                   # 路由匯總
│   ├── services/                       # 業務邏輯層
│   │   ├── aiService.js               # AI模型服務
│   │   ├── chatService.js             # 聊天服務
│   │   ├── agentService.js            # 智能體服務
│   │   ├── workflowService.js         # 工作流服務
│   │   ├── knowledgeService.js        # 知識庫服務
│   │   ├── mcpService.js              # MCP工具服務
│   │   └── notificationService.js     # 通知服務
│   ├── models/                         # 數據模型層
│   │   ├── User.js                    # 用戶模型
│   │   ├── Conversation.js            # 對話模型
│   │   ├── Message.js                 # 訊息模型
│   │   ├── Agent.js                   # 智能體模型
│   │   ├── AIModel.js                 # AI模型
│   │   ├── Workflow.js                # 工作流模型
│   │   └── index.js                   # 模型匯總
│   ├── middleware/                     # 中間件
│   │   ├── auth.js                    # 認證中間件
│   │   ├── admin.js                   # 管理員權限中間件
│   │   ├── validation.js              # 數據驗證中間件
│   │   ├── rateLimit.js               # 限流中間件
│   │   ├── logger.js                  # 日誌中間件
│   │   └── errorHandler.js            # 錯誤處理中間件
│   ├── utils/                          # 工具函數
│   │   ├── database.js                # 資料庫連接
│   │   ├── encryption.js              # 加密工具
│   │   ├── jwt.js                     # JWT工具
│   │   ├── fileHandler.js             # 檔案處理
│   │   ├── logger.js                  # 日誌工具
│   │   └── validator.js               # 驗證工具
│   ├── config/                         # 配置文件
│   │   ├── database.js                # 資料庫配置
│   │   ├── swagger.js                 # Swagger配置
│   │   ├── cors.js                    # CORS配置
│   │   └── index.js                   # 配置匯總
│   ├── docs/                           # API文檔
│   │   ├── swagger/                   # Swagger定義
│   │   │   ├── auth.yaml
│   │   │   ├── chat.yaml
│   │   │   ├── models.yaml
│   │   │   ├── agents.yaml
│   │   │   └── workflows.yaml
│   │   └── schemas/                   # 數據模式定義
│   │       ├── user.yaml
│   │       ├── message.yaml
│   │       └── agent.yaml
│   └── websocket/                      # WebSocket處理
│       ├── chatHandler.js             # 聊天WebSocket
│       ├── notificationHandler.js     # 通知WebSocket
│       └── index.js                   # WebSocket匯總
├── database/                           # 資料庫相關
│   ├── migrations/                    # 資料庫遷移
│   │   ├── 001_create_users_table.sql
│   │   ├── 002_create_models_table.sql
│   │   ├── 003_create_agents_table.sql
│   │   ├── 004_create_conversations_table.sql
│   │   ├── 005_create_messages_table.sql
│   │   └── 006_create_workflows_table.sql
│   ├── seeds/                         # 初始數據
│   │   ├── default_models.sql
│   │   ├── default_agents.sql
│   │   └── admin_user.sql
│   └── schema.sql                     # 完整資料庫結構
├── uploads/                            # 檔案上傳目錄
│   ├── avatars/                       # 頭像
│   ├── attachments/                   # 聊天附件
│   └── documents/                     # 文檔
├── logs/                               # 日誌目錄
│   ├── access.log                     # 訪問日誌
│   ├── error.log                      # 錯誤日誌
│   └── audit.log                      # 審計日誌
├── tests/                              # 測試文件
│   ├── unit/                          # 單元測試
│   ├── integration/                   # 整合測試
│   └── fixtures/                      # 測試數據
├── server.js                          # 服務器入口
├── package.json
├── .env.example                       # 環境變量範例
├── docker-compose.yml                 # Docker配置
├── Dockerfile
└── README.md
```

---

## 🗄️ 資料庫設計

### **核心表結構**

```sql
-- 用戶表
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role ENUM('user', 'admin') DEFAULT 'user',
    department VARCHAR(100),
    avatar_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    last_login_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_role (role)
);

-- AI模型表
CREATE TABLE ai_models (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(200) NOT NULL,
    model_type ENUM('ollama', 'gemini') NOT NULL,
    model_id VARCHAR(200) NOT NULL,
    endpoint_url VARCHAR(500),
    api_key TEXT, -- 加密存儲
    parameters JSON,
    capabilities JSON,
    is_active BOOLEAN DEFAULT TRUE,
    is_multimodal BOOLEAN DEFAULT FALSE,
    max_tokens INT DEFAULT 4096,
    cost_per_1k_tokens DECIMAL(10,6) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_model_type (model_type),
    INDEX idx_is_active (is_active)
);

-- 智能體表
CREATE TABLE agents (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(200) NOT NULL,
    description TEXT,
    avatar_url VARCHAR(500),
    system_prompt TEXT NOT NULL,
    model_id INT NOT NULL,
    parameters JSON,
    capabilities JSON,
    is_active BOOLEAN DEFAULT TRUE,
    usage_count INT DEFAULT 0,
    created_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (model_id) REFERENCES ai_models(id),
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_is_active (is_active),
    INDEX idx_model_id (model_id)
);

-- 對話表
CREATE TABLE conversations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    agent_id INT NULL,
    model_id INT NOT NULL,
    title VARCHAR(200),
    is_active BOOLEAN DEFAULT TRUE,
    message_count INT DEFAULT 0,
    total_tokens INT DEFAULT 0,
    total_cost DECIMAL(10,6) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (agent_id) REFERENCES agents(id),
    FOREIGN KEY (model_id) REFERENCES ai_models(id),
    INDEX idx_user_id (user_id),
    INDEX idx_agent_id (agent_id),
    INDEX idx_created_at (created_at)
);

-- 訊息表
CREATE TABLE messages (
    id INT AUTO_INCREMENT PRIMARY KEY,
    conversation_id INT NOT NULL,
    role ENUM('user', 'assistant', 'system') NOT NULL,
    content TEXT NOT NULL,
    attachments JSON,
    tokens_used INT DEFAULT 0,
    cost DECIMAL(10,6) DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (conversation_id) REFERENCES conversations(id) ON DELETE CASCADE,
    INDEX idx_conversation_id (conversation_id),
    INDEX idx_created_at (created_at)
);

-- 命令詞模板表
CREATE TABLE prompt_templates (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(200) NOT NULL,
    category VARCHAR(50),
    template TEXT NOT NULL,
    variables JSON,
    is_active BOOLEAN DEFAULT TRUE,
    usage_count INT DEFAULT 0,
    created_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_category (category),
    INDEX idx_is_active (is_active)
);

-- MCP工具表
CREATE TABLE mcp_tools (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(200) NOT NULL,
    description TEXT,
    tool_type VARCHAR(50),
    config JSON,
    is_active BOOLEAN DEFAULT TRUE,
    usage_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_tool_type (tool_type),
    INDEX idx_is_active (is_active)
);

-- 工作流表
CREATE TABLE workflows (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    display_name VARCHAR(200) NOT NULL,
    description TEXT,
    definition JSON,
    trigger_type ENUM('manual', 'scheduled', 'event') DEFAULT 'manual',
    schedule_config JSON,
    is_active BOOLEAN DEFAULT TRUE,
    execution_count INT DEFAULT 0,
    created_by INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (created_by) REFERENCES users(id),
    INDEX idx_trigger_type (trigger_type),
    INDEX idx_is_active (is_active)
);

-- 工作流執行記錄表
CREATE TABLE workflow_executions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    workflow_id INT NOT NULL,
    triggered_by INT,
    status ENUM('running', 'completed', 'failed', 'cancelled') DEFAULT 'running',
    input_data JSON,
    output_data JSON,
    error_message TEXT,
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    execution_time INT, -- 執行時間(秒)
    FOREIGN KEY (workflow_id) REFERENCES workflows(id),
    FOREIGN KEY (triggered_by) REFERENCES users(id),
    INDEX idx_workflow_id (workflow_id),
    INDEX idx_status (status),
    INDEX idx_started_at (started_at)
);

-- 系統日誌表
CREATE TABLE audit_logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    action VARCHAR(100) NOT NULL,
    resource_type VARCHAR(50),
    resource_id INT,
    details JSON,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id),
    INDEX idx_user_id (user_id),
    INDEX idx_action (action),
    INDEX idx_created_at (created_at)
);
```

---

## 🔧 後端 API 設計範例

### **路由結構 (含 Swagger)**

```javascript
// routes/chat.js
const express = require("express");
const router = express.Router();
const chatController = require("../controllers/chatController");
const { auth, validate } = require("../middleware");

/**
 * @swagger
 * /api/chat/conversations:
 *   get:
 *     summary: 獲取用戶對話列表
 *     tags: [Chat]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *         description: 頁碼
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 20
 *         description: 每頁數量
 *     responses:
 *       200:
 *         description: 成功獲取對話列表
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Conversation'
 *                 pagination:
 *                   $ref: '#/components/schemas/Pagination'
 */
router.get("/conversations", auth, chatController.getConversations);

/**
 * @swagger
 * /api/chat/conversations:
 *   post:
 *     summary: 創建新對話
 *     tags: [Chat]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - model_id
 *             properties:
 *               model_id:
 *                 type: integer
 *                 description: AI模型ID
 *               agent_id:
 *                 type: integer
 *                 description: 智能體ID (可選)
 *               title:
 *                 type: string
 *                 description: 對話標題
 *     responses:
 *       201:
 *         description: 對話創建成功
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   $ref: '#/components/schemas/Conversation'
 */
router.post(
  "/conversations",
  auth,
  validate("createConversation"),
  chatController.createConversation
);

/**
 * @swagger
 * /api/chat/conversations/{id}/messages:
 *   post:
 *     summary: 發送訊息
 *     tags: [Chat]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: integer
 *         description: 對話ID
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - content
 *             properties:
 *               content:
 *                 type: string
 *                 description: 訊息內容
 *               attachments:
 *                 type: array
 *                 items:
 *                   type: object
 *                   properties:
 *                     type:
 *                       type: string
 *                     url:
 *                       type: string
 *                     name:
 *                       type: string
 *     responses:
 *       200:
 *         description: 訊息發送成功
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     userMessage:
 *                       $ref: '#/components/schemas/Message'
 *                     assistantMessage:
 *                       $ref: '#/components/schemas/Message'
 */
router.post(
  "/conversations/:id/messages",
  auth,
  validate("sendMessage"),
  chatController.sendMessage
);

module.exports = router;
```

### **控制器範例**

```javascript
// controllers/chatController.js
const chatService = require("../services/chatService");
const { successResponse, errorResponse } = require("../utils/response");

class ChatController {
  /**
   * 獲取用戶對話列表
   */
  async getConversations(req, res, next) {
    try {
      const { page = 1, limit = 20 } = req.query;
      const userId = req.user.id;

      const result = await chatService.getUserConversations(userId, {
        page,
        limit,
      });

      return successResponse(res, result, "獲取對話列表成功");
    } catch (error) {
      next(error);
    }
  }

  /**
   * 創建新對話
   */
  async createConversation(req, res, next) {
    try {
      const { model_id, agent_id, title } = req.body;
      const userId = req.user.id;

      const conversation = await chatService.createConversation({
        user_id: userId,
        model_id,
        agent_id,
        title,
      });

      return successResponse(res, conversation, "對話創建成功", 201);
    } catch (error) {
      next(error);
    }
  }

  /**
   * 發送訊息
   */
  async sendMessage(req, res, next) {
    try {
      const { id: conversationId } = req.params;
      const { content, attachments } = req.body;
      const userId = req.user.id;

      const result = await chatService.sendMessage({
        conversationId,
        userId,
        content,
        attachments,
      });

      return successResponse(res, result, "訊息發送成功");
    } catch (error) {
      next(error);
    }
  }

  /**
   * 獲取對話訊息
   */
  async getMessages(req, res, next) {
    try {
      const { id: conversationId } = req.params;
      const { page = 1, limit = 50 } = req.query;
      const userId = req.user.id;

      const messages = await chatService.getConversationMessages(
        conversationId,
        userId,
        { page, limit }
      );

      return successResponse(res, messages, "獲取訊息成功");
    } catch (error) {
      next(error);
    }
  }

  /**
   * 刪除對話
   */
  async deleteConversation(req, res, next) {
    try {
      const { id: conversationId } = req.params;
      const userId = req.user.id;

      await chatService.deleteConversation(conversationId, userId);

      return successResponse(res, null, "對話刪除成功");
    } catch (error) {
      next(error);
    }
  }
}

module.exports = new ChatController();
```

### **Swagger 配置**

````javascript
// config/swagger.js
const swaggerJsdoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'sfda_nexus API',
      version: '1.0.0',
      description: '企業AI聊天系統 API 文檔',
      contact: {
        name: 'API Support',
        email: 'support@company.com'
      }
    },
    servers: [
      {
        url: process.env.API_BASE_URL || 'http://localhost:3000',
        description: '開發環境'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      },
      schemas: {
        User: {
          ```javascript
        User: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: '用戶ID'
            },
            username: {
              type: 'string',
              description: '用戶名'
            },
            email: {
              type: 'string',
              format: 'email',
              description: '電子郵件'
            },
            role: {
              type: 'string',
              enum: ['user', 'admin'],
              description: '用戶角色'
            },
            department: {
              type: 'string',
              description: '部門'
            },
            avatar_url: {
              type: 'string',
              description: '頭像URL'
            },
            is_active: {
              type: 'boolean',
              description: '是否啟用'
            },
            created_at: {
              type: 'string',
              format: 'date-time',
              description: '創建時間'
            }
          }
        },
        Conversation: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: '對話ID'
            },
            user_id: {
              type: 'integer',
              description: '用戶ID'
            },
            agent_id: {
              type: 'integer',
              nullable: true,
              description: '智能體ID'
            },
            model_id: {
              type: 'integer',
              description: '模型ID'
            },
            title: {
              type: 'string',
              description: '對話標題'
            },
            message_count: {
              type: 'integer',
              description: '訊息數量'
            },
            total_tokens: {
              type: 'integer',
              description: '總token數'
            },
            total_cost: {
              type: 'number',
              format: 'float',
              description: '總費用'
            },
            created_at: {
              type: 'string',
              format: 'date-time',
              description: '創建時間'
            },
            updated_at: {
              type: 'string',
              format: 'date-time',
              description: '更新時間'
            },
            agent_name: {
              type: 'string',
              description: '智能體名稱'
            },
            model_name: {
              type: 'string',
              description: '模型名稱'
            }
          }
        },
        Message: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: '訊息ID'
            },
            conversation_id: {
              type: 'integer',
              description: '對話ID'
            },
            role: {
              type: 'string',
              enum: ['user', 'assistant', 'system'],
              description: '角色'
            },
            content: {
              type: 'string',
              description: '訊息內容'
            },
            attachments: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  type: {
                    type: 'string',
                    description: '附件類型'
                  },
                  url: {
                    type: 'string',
                    description: '附件URL'
                  },
                  name: {
                    type: 'string',
                    description: '附件名稱'
                  },
                  size: {
                    type: 'integer',
                    description: '附件大小'
                  }
                }
              },
              description: '附件列表'
            },
            tokens_used: {
              type: 'integer',
              description: '使用的token數'
            },
            cost: {
              type: 'number',
              format: 'float',
              description: '費用'
            },
            created_at: {
              type: 'string',
              format: 'date-time',
              description: '創建時間'
            }
          }
        },
        Agent: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: '智能體ID'
            },
            name: {
              type: 'string',
              description: '智能體名稱'
            },
            display_name: {
              type: 'string',
              description: '顯示名稱'
            },
            description: {
              type: 'string',
              description: '描述'
            },
            avatar_url: {
              type: 'string',
              description: '頭像URL'
            },
            system_prompt: {
              type: 'string',
              description: '系統提示詞'
            },
            model_id: {
              type: 'integer',
              description: '關聯模型ID'
            },
            capabilities: {
              type: 'object',
              description: '能力配置'
            },
            is_active: {
              type: 'boolean',
              description: '是否啟用'
            },
            usage_count: {
              type: 'integer',
              description: '使用次數'
            }
          }
        },
        AIModel: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: '模型ID'
            },
            name: {
              type: 'string',
              description: '模型名稱'
            },
            display_name: {
              type: 'string',
              description: '顯示名稱'
            },
            model_type: {
              type: 'string',
              enum: ['ollama', 'gemini'],
              description: '模型類型'
            },
            model_id: {
              type: 'string',
              description: '模型標識符'
            },
            endpoint_url: {
              type: 'string',
              description: '端點URL'
            },
            is_active: {
              type: 'boolean',
              description: '是否啟用'
            },
            is_multimodal: {
              type: 'boolean',
              description: '是否支援多模態'
            },
            max_tokens: {
              type: 'integer',
              description: '最大token數'
            }
          }
        },
        Pagination: {
          type: 'object',
          properties: {
            page: {
              type: 'integer',
              description: '當前頁碼'
            },
            limit: {
              type: 'integer',
              description: '每頁數量'
            },
            total: {
              type: 'integer',
              description: '總記錄數'
            },
            totalPages: {
              type: 'integer',
              description: '總頁數'
            }
          }
        },
        Error: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: false
            },
            message: {
              type: 'string',
              description: '錯誤訊息'
            },
            code: {
              type: 'string',
              description: '錯誤代碼'
            },
            details: {
              type: 'object',
              description: '錯誤詳情'
            }
          }
        }
      }
    }
  },
  apis: ['./src/routes/*.js'] // 掃描路由文件中的註釋
};

const specs = swaggerJsdoc(options);

module.exports = {
  specs,
  swaggerUi,
  setup: swaggerUi.setup(specs, {
    explorer: true,
    customCss: '.swagger-ui .topbar { display: none }',
    customSiteTitle: 'sfda_nexus API 文檔'
  })
};
````

---

## 🔄 開發階段規劃

### **第一期 - 核心功能 (3-4 週)**

#### **Week 1: 基礎架構搭建**

- [x] 專案初始化 (前後端)
- [x] 資料庫設計與建立
- [x] 認證系統 (JWT)
- [x] 基礎路由與中間件
- [x] Swagger API 文檔設置

#### **Week 2: 聊天核心功能**

- [x] 聊天界面開發 (Vue + Ant Design)
- [x] WebSocket 實時通信
- [x] Ollama 模型整合
- [x] 檔案上傳功能
- [x] 訊息存儲與查詢

#### **Week 3: 模型與智能體管理**

- [x] AI 模型管理 (CRUD)
- [x] Gemini API 整合
- [x] 智能體系統開發
- [x] 命令詞模板功能
- [x] 管理員界面開發

#### **Week 4: 系統完善**

- [x] 用戶權限系統
- [x] 系統監控與日誌
- [x] 錯誤處理與驗證
- [x] 單元測試
- [x] 部署配置

### **第二期 - 進階功能 (2-3 週)**

#### **Week 5-6: 工作流系統**

- [ ] 工作流設計器
- [ ] 工作流執行引擎
- [ ] 排程任務系統
- [ ] 執行監控與日誌

#### **Week 7: 知識庫與 MCP 工具**

- [ ] 向量資料庫整合 (Qdrant)
- [ ] 文檔上傳與處理
- [ ] MCP 工具開發
- [ ] 知識檢索功能

### **第三期 - 優化與擴展 (2 週)**

#### **Week 8-9: 系統優化**

- [ ] 性能優化
- [ ] 安全性加強
- [ ] 監控與分析
- [ ] 用戶體驗優化

---

## 🛠️ 開發環境設置

### **前端開發環境**

```json
// frontend/package.json
{
  "name": "sfda-nexus-frontend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview",
    "lint": "eslint . --ext .vue,.js,.jsx,.cjs,.mjs --fix",
    "format": "prettier --write src/"
  },
  "dependencies": {
    "vue": "^3.4.0",
    "vue-router": "^4.2.5",
    "pinia": "^2.1.7",
    "ant-design-vue": "^4.0.0",
    "@ant-design/icons-vue": "^7.0.0",
    "axios": "^1.6.0",
    "dayjs": "^1.11.10",
    "marked": "^9.1.0",
    "highlight.js": "^11.9.0"
  },
  "devDependencies": {
    "@vitejs/plugin-vue": "^4.5.0",
    "vite": "^5.0.0",
    "eslint": "^8.55.0",
    "eslint-plugin-vue": "^9.19.0",
    "prettier": "^3.1.0",
    "@vue/eslint-config-prettier": "^8.0.0"
  }
}
```

```javascript
// frontend/vite.config.js
import { defineConfig } from "vite";
import vue from "@vitejs/plugin-vue";
import { resolve } from "path";

export default defineConfig({
  plugins: [vue()],
  resolve: {
    alias: {
      "@": resolve(__dirname, "src"),
    },
  },
  server: {
    port: 8080,
    proxy: {
      "/api": {
        target: "http://localhost:3000",
        changeOrigin: true,
      },
      "/ws": {
        target: "ws://localhost:3000",
        ws: true,
      },
    },
  },
  build: {
    outDir: "../backend/public",
    emptyOutDir: true,
  },
});
```

### **後端開發環境**

```json
// backend/package.json
{
  "name": "sfda-nexus-backend",
  "version": "1.0.0",
  "type": "commonjs",
  "scripts": {
    "dev": "nodemon server.js",
    "start": "node server.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "migrate": "node database/migrate.js",
    "seed": "node database/seed.js",
    "lint": "eslint . --fix",
    "format": "prettier --write ."
  },
  "dependencies": {
    "express": "^4.18.2",
    "mysql2": "^3.6.5",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "multer": "^1.4.5",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "axios": "^1.6.0",
    "ws": "^8.14.2",
    "joi": "^17.11.0",
    "helmet": "^7.1.0",
    "express-rate-limit": "^7.1.5",
    "winston": "^3.11.0",
    "swagger-jsdoc": "^6.2.8",
    "swagger-ui-express": "^5.0.0",
    "crypto-js": "^4.2.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.2",
    "jest": "^29.7.0",
    "supertest": "^6.3.3",
    "eslint": "^8.55.0",
    "prettier": "^3.1.0"
  }
}
```

### **環境變量配置**

```env
# backend/.env.example
# 服務器配置
NODE_ENV=development
PORT=3000
API_BASE_URL=http://localhost:3000

# 資料庫配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=sfda_nexus
DB_USER=root
DB_PASSWORD=your_password

# JWT配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=7d

# AI模型配置
OLLAMA_BASE_URL=http://localhost:11434
GEMINI_API_KEY=your_gemini_api_key

# 檔案上傳配置
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760

# 日誌配置
LOG_LEVEL=info
LOG_DIR=./logs

# 安全配置
BCRYPT_ROUNDS=12
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100

# WebSocket配置
WS_PORT=3001

# 向量資料庫配置 (第二期)
QDRANT_URL=http://localhost:6333
QDRANT_API_KEY=your_qdrant_api_key
```

---

## 🐳 Docker 部署配置

### **Dockerfile**

```dockerfile
# 多階段構建
FROM node:18-alpine AS frontend-builder

WORKDIR /app/frontend
COPY frontend/package*.json ./
RUN npm ci --only=production

COPY frontend/ ./
RUN npm run build

FROM node:18-alpine AS backend

WORKDIR /app

# 安裝後端依賴
COPY backend/package*.json ./
RUN npm ci --only=production

# 複製後端代碼
COPY backend/ ./

# 複製前端構建結果
COPY --from=frontend-builder /app/backend/public ./public

# 創建必要目錄
RUN mkdir -p uploads logs

# 設置權限
RUN chown -R node:node /app
USER node

EXPOSE 3000

HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

CMD ["npm", "start"]
```

### **docker-compose.yml**

```yaml
version: "3.8"

services:
  app:
    build: .
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DB_HOST=mysql
      - DB_NAME=sfda_nexus
      - DB_USER=sfda_user
      - DB_PASSWORD=${DB_PASSWORD}
      - JWT_SECRET=${JWT_SECRET}
      - OLLAMA_BASE_URL=http://ollama:11434
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    depends_on:
      mysql:
        condition: service_healthy
      ollama:
        condition: service_started
    volumes:
      - app_uploads:/app/uploads
      - app_logs:/app/logs
    networks:
      - sfda_network
    restart: unless-stopped

  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=sfda_nexus
      - MYSQL_USER=sfda_user
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./database/schema.sql:/docker-entrypoint-initdb.d/01-schema.sql
      - ./database/seeds:/docker-entrypoint-initdb.d/seeds
    ports:
      - "3306:3306"
    networks:
      - sfda_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 20s
      retries: 10
    restart: unless-stopped

  ollama:
    image: ollama/ollama:latest
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - sfda_network
    environment:
      - OLLAMA_ORIGINS=*
    restart: unless-stopped

  # 第二期新增：向量資料庫
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - sfda_network
    restart: unless-stopped
    profiles:
      - stage2

  # 監控服務 (可選)
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - app
    networks:
      - sfda_network
    restart: unless-stopped
    profiles:
      - production

volumes:
  mysql_data:
  ollama_data:
  qdrant_data:
  app_uploads:
  app_logs:

networks:
  sfda_network:
    driver: bridge
```

### **部署腳本**

```bash
#!/bin/bash
# deploy.sh

set -e

echo "🚀 開始部署 sfda_nexus..."

# 檢查環境變量
if [ ! -f .env ]; then
    echo "❌ 請先創建 .env 文件"
    exit 1
fi

# 載入環境變量
source .env

# 停止現有服務
echo "⏹️  停止現有服務..."
docker-compose down

# 拉取最新鏡像
echo "📥 拉取最新鏡像..."
docker-compose pull

# 構建應用鏡像
echo "🔨 構建應用鏡像..."
docker-compose build app

# 啟動服務
echo "▶️  啟動服務..."
docker-compose up -d

# 等待服務啟動
echo "⏳ 等待服務啟動..."
sleep 30

# 執行資料庫遷移
echo "🗄️  執行資料庫遷移..."
docker-compose exec app npm run migrate

# 執行資料庫種子
echo "🌱 執行資料庫種子..."
docker-compose exec app npm run seed

# 檢查服務狀態
echo "✅ 檢查服務狀態..."
docker-compose ps

echo "🎉 部署完成！"
echo "📊 管理界面: http://localhost:3000"
echo "📚 API文檔: http://localhost:3000/api-docs"
```

---

## 📊 監控與日誌

### **日誌配置**

```javascript
// utils/logger.js
const winston = require("winston");
const path = require("path");

const logDir = process.env.LOG_DIR || "./logs";

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: "sfda-nexus" },
  transports: [
    // 錯誤日誌
    new winston.transports.File({
      filename: path.join(logDir, "error.log"),
      level: "error",
      maxsize: 5242880, // 5MB
      maxFiles: 5,
    }),
    // 所有日誌
    new winston.transports.File({
      filename: path.join(logDir, "combined.log"),
      maxsize: 5242880,
      maxFiles: 5,
    }),
    // 審計日誌
    new winston.transports.File({
      filename: path.join(logDir, "audit.log"),
      level: "info",
      maxsize: 5242880,
      maxFiles: 10,
    }),
  ],
});

// 開發環境下輸出到控制台
if (process.env.NODE_ENV !== "production") {
  logger.add(
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      ),
    })
  );
}

module.exports = logger;
```

### **健康檢查端點**

```javascript
// routes/health.js
const express = require("express");
const router = express.Router();
const db = require("../utils/database");

router.get("/health", async (req, res) => {
  const health = {
    status: "ok",
    timestamp: new Date().toISOString(),
    services: {},
  };

  try {
    // 檢查資料庫連接
    await db.query("SELECT 1");
    health.services.database = "ok";
  } catch (error) {
    health.services.database = "error";
    health.status = "error";
  }

  // 檢查 Ollama 連接
  try {
    const response = await axios.get(`${process.env.OLLAMA_BASE_URL}/api/tags`);
    health.services.ollama = response.status === 200 ? "ok" : "error";
  } catch (error) {
    health.services.ollama = "error";
  }

  const statusCode = health.status === "ok" ? 200 : 503;
  res.status(statusCode).json(health);
});

module.exports = router;
```

---

## 🧪 測試策略

### **測試結構**

```
tests/
├── unit/                    # 單元測試
│   ├── controllers/
│   ├── services/
│   ├── models/
│   └── utils/
├── integration/             # 整合測試
│   ├── api/
│   ├── database/
│   └── websocket/
├── e2e/                     # 端到端測試
│   ├── auth.test.js
│   ├── chat.test.js
│   └── admin.test.js
├── fixtures/                # 測試數據
│   ├── users.json
│   ├── models.json
│   └── conversations.json
└── setup/                   # 測試設置
    ├── database.js
    ├── server.js
    └── cleanup.js
```

### **測試範例**

```javascript
// tests/integration/api/chat.test.js
const request = require("supertest");
const app = require("../../../server");
const db = require("../../../src/utils/database");

describe("Chat API", () => {
  let authToken;
  let userId;

  beforeAll(async () => {
    // 創建測試用戶並獲取token
    const response = await request(app).post("/api/auth/login").send({
      username: "testuser",
      password: "testpass",
    });

    authToken = response.body.data.token;
    userId = response.body.data.user.id;
  });

  afterAll(async () => {
    // 清理測試數據
    await db.query(
      "DELETE FROM messages WHERE conversation_id IN (SELECT id FROM conversations WHERE user_id = ?)",
      [userId]
    );
    await db.query("DELETE FROM conversations WHERE user_id = ?", [userId]);
  });

  describe("POST /api/chat/conversations", () => {
    it("should create a new conversation", async () => {
      const response = await request(app)
        .post("/api/chat/conversations")
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          model_id: 1,
          title: "Test Conversation",
        });

      expect(response.status).toBe(201);
      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty("id");
      expect(response.body.data.title).toBe("Test Conversation");
    });

    it("should return 400 for invalid model_id", async () => {
      const response = await request(app)
        .post("/api/chat/conversations")
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          model_id: 999,
          title: "Test Conversation",
        });

      expect(response.status).toBe(400);
      expect(response.body.success).toBe(false);
    });
  });

  describe("POST /api/chat/conversations/:id/messages", () => {
    let conversationId;

    beforeEach(async () => {
      const response = await request(app)
        .post("/api/chat/conversations")
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          model_id: 1,
          title: "Test Conversation",
        });

      conversationId = response.body.data.id;
    });

    it("should send a message and receive AI response", async () => {
      const response = await request(app)
        .post(`/api/chat/conversations/${conversationId}/messages`)
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          content: "Hello, how are you?",
        });

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty("userMessage");
      expect(response.body.data).toHaveProperty("assistantMessage");
      expect(response.body.data.userMessage.content).toBe(
        "Hello, how are you?"
      );
    });
  });
});
```

---

## 📈 性能優化建議

### **資料庫優化**

- 添加適當的索引
- 使用連接池
- 實施查詢快取
- 定期清理舊數據

### **API 優化**

- 實施分頁
- 使用壓縮中間件
- 添加快取層 (Redis)
- API 限流

### **前端優化**

- 組件懶加載
- 圖片壓縮與 CDN
- 打包優化
- 服務端渲染 (可選)

---

## 🔒 安全性考慮

### **認證與授權**

- JWT token 過期機制
- 角色權限控制
- API 限流
- 輸入驗證與清理

### **數據安全**

- API Key 加密存儲
- 敏感數據脫敏
- SQL 注入防護
- XSS 防護

### **系統安全**

- HTTPS 強制
- CORS 配置
- 安全標頭設置
- 定期安全更新

---

## 📅 開發時程表

| 階段   | 時間     | 主要功能       | 里程碑     |
| ------ | -------- | -------------- | ---------- |
| 第一期 | Week 1-4 | 核心聊天功能   | MVP 上線   |
| 第二期 | Week 5-7 | 工作流與知識庫 | 功能完整版 |
| 第三期 | Week 8-9 | 優化與擴展     | 生產就緒版 |

---

## 🎯 成功指標

### **技術指標**

- API 響應時間 < 500ms
- 系統可用性 > 99.5%
- 並發用戶數 > 100
- 資料庫查詢優化

### **業務指標**

- 用戶滿意度 > 4.5/5
- 日活躍用戶數
- 平均對話長度
- 功能使用率

---

這個開發計劃提供了完整的技術架構、開發流程和部署策略。你覺得這個規劃如何？需要調整哪些部分嗎？
