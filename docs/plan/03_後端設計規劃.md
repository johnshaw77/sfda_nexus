### **å¾Œç«¯é–‹ç™¼ç’°å¢ƒ**

```json
// backend/package.json
{
  "name": "sfda-nexus-backend",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "nodemon server.js",
    "start": "node server.js",
    "test": "jest",
    "test:watch": "jest --watch",
    "migrate": "node database/migrate.js",
    "seed": "node database/seed.js",
    "lint": "eslint . --fix",
    "format": "prettier --write ."
  },
  "dependencies": {
    "express": "^4.18.2",
    "mysql2": "^3.6.5",
    "bcryptjs": "^2.4.3",
    "jsonwebtoken": "^9.0.2",
    "multer": "^1.4.5",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "axios": "^1.6.0",
    "ws": "^8.14.2",
    "joi": "^17.11.0",
    "helmet": "^7.1.0",
    "express-rate-limit": "^7.1.5",
    "winston": "^3.11.0",
    "swagger-jsdoc": "^6.2.8",
    "swagger-ui-express": "^5.0.0",
    "crypto-js": "^4.2.0"
  },
  "devDependencies": {
    "nodemon": "^3.0.2",
    "jest": "^29.7.0",
    "supertest": "^6.3.3",
    "eslint": "^8.55.0",
    "prettier": "^3.1.0"
  }
}
```

### **ç’°å¢ƒè®Šé‡é…ç½®**

```env
# backend/.env.example
# æœå‹™å™¨é…ç½®
NODE_ENV=development
PORT=3000
API_BASE_URL=http://localhost:3000

# è³‡æ–™åº«é…ç½®
DB_HOST=localhost
DB_PORT=3306
DB_NAME=sfda_nexus
DB_USER=root
DB_PASSWORD=MyPwd@1234

# JWTé…ç½®
JWT_SECRET=fcc75e387236fbd501c18213b95d16b519ae46e2b6c4d66c58d5b9f2e9410315
JWT_EXPIRES_IN=7d

# AIæ¨¡å‹é…ç½®

GEMINI_API_KEY=AIzaSyBsx_xwVDoqRiP1pIit5ScCD7xQcgcotuI
GEMINI_API_URL=https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent

# Ollama æœ¬åœ°æœå‹™é…ç½®
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_MODEL=qwen3:30b

# æª”æ¡ˆä¸Šå‚³é…ç½®
UPLOAD_DIR=./uploads
MAX_FILE_SIZE=10485760

# æ—¥èªŒé…ç½®
LOG_LEVEL=info
LOG_DIR=./logs

# å®‰å…¨é…ç½®
BCRYPT_ROUNDS=12
RATE_LIMIT_WINDOW=15
RATE_LIMIT_MAX=100

# WebSocketé…ç½®
WS_PORT=3001

# å‘é‡è³‡æ–™åº«é…ç½® (ç¬¬äºŒæœŸ)
QDRANT_URL=http://localhost:6333
QDRANT_API_KEY=your_qdrant_api_key
```

## ğŸ“ å¾Œç«¯ç›®éŒ„çµæ§‹

```
backend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ controllers/                    # æ§åˆ¶å™¨å±¤
â”‚   â”‚   â”œâ”€â”€ auth.controller.js          # èªè­‰æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ chat.controller.js          # èŠå¤©æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ model.controller.js         # æ¨¡å‹æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ agent.controller.js         # æ™ºèƒ½é«”æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ workflow.controller.js      # å·¥ä½œæµæ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ user.controller.js          # ç”¨æˆ¶æ§åˆ¶å™¨
â”‚   â”‚   â”œâ”€â”€ tool.controller.js          # å·¥å…·æ§åˆ¶å™¨
â”‚   â”‚   â””â”€â”€ admin.controller.js         # ç®¡ç†æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ routes/                         # è·¯ç”±å±¤
â”‚   â”‚   â”œâ”€â”€ auth.route.js                    # èªè­‰è·¯ç”± + Swagger
â”‚   â”‚   â”œâ”€â”€ chat.route.js                    # èŠå¤©è·¯ç”± + Swagger
â”‚   â”‚   â”œâ”€â”€ models.route.js                  # æ¨¡å‹è·¯ç”± + Swagger
â”‚   â”‚   â”œâ”€â”€ agents.route.js                  # æ™ºèƒ½é«”è·¯ç”± + Swagger
â”‚   â”‚   â”œâ”€â”€ workflows.route.js               # å·¥ä½œæµè·¯ç”± + Swagger
â”‚   â”‚   â”œâ”€â”€ users.route.js                   # ç”¨æˆ¶è·¯ç”± + Swagger
â”‚   â”‚   â”œâ”€â”€ tools.route.js                   # å·¥å…·è·¯ç”± + Swagger
â”‚   â”‚   â”œâ”€â”€ admin.route.js                   # ç®¡ç†è·¯ç”± + Swagger
â”‚   â”‚   â””â”€â”€ index.route.js                   # è·¯ç”±åŒ¯ç¸½
â”‚   â”œâ”€â”€ services/                       # æ¥­å‹™é‚è¼¯å±¤
â”‚   â”‚   â”œâ”€â”€ ai.service.js               # AIæ¨¡å‹æœå‹™
â”‚   â”‚   â”œâ”€â”€ chat.service.js             # èŠå¤©æœå‹™
â”‚   â”‚   â”œâ”€â”€ agent.service.js            # æ™ºèƒ½é«”æœå‹™
â”‚   â”‚   â”œâ”€â”€ workflow.service.js         # å·¥ä½œæµæœå‹™
â”‚   â”‚   â”œâ”€â”€ knowledge.service.js        # çŸ¥è­˜åº«æœå‹™
â”‚   â”‚   â”œâ”€â”€ mcp.service.js              # MCPå·¥å…·æœå‹™
â”‚   â”‚   â””â”€â”€ notification.service.js     # é€šçŸ¥æœå‹™
â”‚   â”œâ”€â”€ models/                         # æ•¸æ“šæ¨¡å‹å±¤
â”‚   â”‚   â”œâ”€â”€ User.js                    # ç”¨æˆ¶æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Conversation.js            # å°è©±æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Message.js                 # è¨Šæ¯æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Agent.js                   # æ™ºèƒ½é«”æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ AIModel.js                 # AIæ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ Workflow.js                # å·¥ä½œæµæ¨¡å‹
â”‚   â”‚   â””â”€â”€ index.js                   # æ¨¡å‹åŒ¯ç¸½
â”‚   â”œâ”€â”€ middleware/                     # ä¸­é–“ä»¶
â”‚   â”‚   â”œâ”€â”€ auth.middleware.js                    # èªè­‰ä¸­é–“ä»¶
â”‚   â”‚   â”œâ”€â”€ admin.middleware.js                   # ç®¡ç†å“¡æ¬Šé™ä¸­é–“ä»¶
â”‚   â”‚   â”œâ”€â”€ validation.middleware.js              # æ•¸æ“šé©—è­‰ä¸­é–“ä»¶
â”‚   â”‚   â”œâ”€â”€ rateLimit.middleware.js               # é™æµä¸­é–“ä»¶
â”‚   â”‚   â”œâ”€â”€ logger.middleware.js                  # æ—¥èªŒä¸­é–“ä»¶
â”‚   â”‚   â””â”€â”€ errorHandler.middleware.js            # éŒ¯èª¤è™•ç†ä¸­é–“ä»¶
â”‚   â”œâ”€â”€ utils/                          # å·¥å…·å‡½æ•¸
â”‚   â”‚   â”œâ”€â”€ database.util.js                # è³‡æ–™åº«é€£æ¥
â”‚   â”‚   â”œâ”€â”€ encryption.util.js              # åŠ å¯†å·¥å…·
â”‚   â”‚   â”œâ”€â”€ jwt.util.js                     # JWTå·¥å…·
â”‚   â”‚   â”œâ”€â”€ fileHandler.util.js             # æª”æ¡ˆè™•ç†
â”‚   â”‚   â”œâ”€â”€ logger.util.js                  # æ—¥èªŒå·¥å…·
â”‚   â”‚   â””â”€â”€ validator.util.js               # é©—è­‰å·¥å…·
â”‚   â”œâ”€â”€ config/                     # é…ç½®æª”æ¡ˆï¼Œå‘½åè¦ç¯„ï¼šxxxx.config.js
â”‚   â”‚   â”œâ”€â”€ database.config.js         # è³‡æ–™åº«é…ç½®
â”‚   â”‚   â”œâ”€â”€ swagger.config.js          # Swaggeré…ç½®
â”‚   â”‚   â”œâ”€â”€ cors.config.js             # CORSé…ç½®
â”‚   â”‚   â””â”€â”€ app.config.js              # æ‡‰ç”¨ç¨‹å¼é…ç½®åŒ¯ç¸½
â”‚   â”œâ”€â”€ docs/                           # APIæ–‡æª”
â”‚   â”‚   â”œâ”€â”€ swagger/                   # Swaggerå®šç¾©
â”‚   â”‚   â”‚   â”œâ”€â”€ auth.yaml
â”‚   â”‚   â”‚   â”œâ”€â”€ chat.yaml
â”‚   â”‚   â”‚   â”œâ”€â”€ models.yaml
â”‚   â”‚   â”‚   â”œâ”€â”€ agents.yaml
â”‚   â”‚   â”‚   â””â”€â”€ workflows.yaml
â”‚   â”‚   â””â”€â”€ schemas/                   # æ•¸æ“šæ¨¡å¼å®šç¾©
â”‚   â”‚       â”œâ”€â”€ user.yaml
â”‚   â”‚       â”œâ”€â”€ message.yaml
â”‚   â”‚       â””â”€â”€ agent.yaml
â”‚   â””â”€â”€ websocket/                      # WebSocketè™•ç†
â”‚       â”œâ”€â”€ chatHandler.js             # èŠå¤©WebSocket
â”‚       â”œâ”€â”€ notificationHandler.js     # é€šçŸ¥WebSocket
â”‚       â””â”€â”€ index.js                   # WebSocketåŒ¯ç¸½
â”œâ”€â”€ database/                           # è³‡æ–™åº«ç›¸é—œ
â”‚   â”œâ”€â”€ migrations/                    # è³‡æ–™åº«é·ç§»
â”‚   â”‚   â”œâ”€â”€ 001_create_users_table.sql
â”‚   â”‚   â”œâ”€â”€ 002_create_models_table.sql
â”‚   â”‚   â”œâ”€â”€ 003_create_agents_table.sql
â”‚   â”‚   â”œâ”€â”€ 004_create_conversations_table.sql
â”‚   â”‚   â”œâ”€â”€ 005_create_messages_table.sql
â”‚   â”‚   â””â”€â”€ 006_create_workflows_table.sql
â”‚   â”œâ”€â”€ seeds/                         # åˆå§‹æ•¸æ“š
â”‚   â”‚   â”œâ”€â”€ default_models.sql
â”‚   â”‚   â”œâ”€â”€ default_agents.sql
â”‚   â”‚   â””â”€â”€ admin_user.sql
â”‚   â””â”€â”€ schema.sql                     # å®Œæ•´è³‡æ–™åº«çµæ§‹
â”œâ”€â”€ uploads/                            # æª”æ¡ˆä¸Šå‚³ç›®éŒ„
â”‚   â”œâ”€â”€ avatars/                       # é ­åƒ
â”‚   â”œâ”€â”€ attachments/                   # èŠå¤©é™„ä»¶
â”‚   â””â”€â”€ documents/                     # æ–‡æª”
â”œâ”€â”€ logs/                               # æ—¥èªŒç›®éŒ„
â”‚   â”œâ”€â”€ access.log                     # è¨ªå•æ—¥èªŒ
â”‚   â”œâ”€â”€ error.log                      # éŒ¯èª¤æ—¥èªŒ
â”‚   â””â”€â”€ audit.log                      # å¯©è¨ˆæ—¥èªŒ
â”œâ”€â”€ tests/                              # æ¸¬è©¦æ–‡ä»¶
â”‚   â”œâ”€â”€ unit/                          # å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ integration/                   # æ•´åˆæ¸¬è©¦
â”‚   â””â”€â”€ fixtures/                      # æ¸¬è©¦æ•¸æ“š
â”œâ”€â”€ server.js                          # æœå‹™å™¨å…¥å£
â”œâ”€â”€ package.json
â”œâ”€â”€ .env.example                       # ç’°å¢ƒè®Šé‡ç¯„ä¾‹
â”œâ”€â”€ docker-compose.yml                 # Dockeré…ç½®
â”œâ”€â”€ Dockerfile
â””â”€â”€ README.md
```

## ğŸ”§ å¾Œç«¯ API è¨­è¨ˆç¯„ä¾‹

### **è·¯ç”±çµæ§‹ (å« Swagger)**

```javascript
// routes/chat.js
const express = require("express");
const router = express.Router();
const chatController = require("../controllers/chatController");
const { auth, validate } = require("../middleware");

/**
 * @swagger
 * /api/chat/conversations:
 *   get:
 *     summary: ç²å–ç”¨æˆ¶å°è©±åˆ—è¡¨
 *     tags: [Chat]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: query
 *         name: page
 *         schema:
 *           type: integer
 *           default: 1
 *         description: é ç¢¼
 *       - in: query
 *         name: limit
 *         schema:
 *           type: integer
 *           default: 20
 *         description: æ¯é æ•¸é‡
 *     responses:
 *       200:
 *         description: æˆåŠŸç²å–å°è©±åˆ—è¡¨
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: array
 *                   items:
 *                     $ref: '#/components/schemas/Conversation'
 *                 pagination:
 *                   $ref: '#/components/schemas/Pagination'
 */
router.get("/conversations", auth, chatController.getConversations);

/**
 * @swagger
 * /api/chat/conversations:
 *   post:
 *     summary: å‰µå»ºæ–°å°è©±
 *     tags: [Chat]
 *     security:
 *       - bearerAuth: []
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - model_id
 *             properties:
 *               model_id:
 *                 type: integer
 *                 description: AIæ¨¡å‹ID
 *               agent_id:
 *                 type: integer
 *                 description: æ™ºèƒ½é«”ID (å¯é¸)
 *               title:
 *                 type: string
 *                 description: å°è©±æ¨™é¡Œ
 *     responses:
 *       201:
 *         description: å°è©±å‰µå»ºæˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   $ref: '#/components/schemas/Conversation'
 */
router.post(
  "/conversations",
  auth,
  validate("createConversation"),
  chatController.createConversation
);

/**
 * @swagger
 * /api/chat/conversations/{id}/messages:
 *   post:
 *     summary: ç™¼é€è¨Šæ¯
 *     tags: [Chat]
 *     security:
 *       - bearerAuth: []
 *     parameters:
 *       - in: path
 *         name: id
 *         required: true
 *         schema:
 *           type: integer
 *         description: å°è©±ID
 *     requestBody:
 *       required: true
 *       content:
 *         application/json:
 *           schema:
 *             type: object
 *             required:
 *               - content
 *             properties:
 *               content:
 *                 type: string
 *                 description: è¨Šæ¯å…§å®¹
 *               attachments:
 *                 type: array
 *                 items:
 *                   type: object
 *                   properties:
 *                     type:
 *                       type: string
 *                     url:
 *                       type: string
 *                     name:
 *                       type: string
 *     responses:
 *       200:
 *         description: è¨Šæ¯ç™¼é€æˆåŠŸ
 *         content:
 *           application/json:
 *             schema:
 *               type: object
 *               properties:
 *                 success:
 *                   type: boolean
 *                 data:
 *                   type: object
 *                   properties:
 *                     userMessage:
 *                       $ref: '#/components/schemas/Message'
 *                     assistantMessage:
 *                       $ref: '#/components/schemas/Message'
 */
router.post(
  "/conversations/:id/messages",
  auth,
  validate("sendMessage"),
  chatController.sendMessage
);

module.exports = router;
```

### **æ§åˆ¶å™¨ç¯„ä¾‹**

`````javascript
module.exports = {
  getConversations: async (req, res) => {

  }
}

### **Swagger é…ç½®**

````javascript
// config/swagger.config.js
const swaggerJsdoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');

const options = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'sfda_nexus API',
      version: '1.0.0',
      description: 'ä¼æ¥­AIèŠå¤©ç³»çµ± API æ–‡æª”',
      contact: {
        name: 'API Support',
        email: 'support@company.com'
      }
    },
    servers: [
      {
        url: process.env.API_BASE_URL || 'http://localhost:3000',
        description: 'é–‹ç™¼ç’°å¢ƒ'
      }
    ],
    components: {
      securitySchemes: {
        bearerAuth: {
          type: 'http',
          scheme: 'bearer',
          bearerFormat: 'JWT'
        }
      },
      schemas: {
        User: {
          ```javascript
        User: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: 'ç”¨æˆ¶ID'
            },
            username: {
              type: 'string',
              description: 'ç”¨æˆ¶å'
            },
            email: {
              type: 'string',
              format: 'email',
              description: 'é›»å­éƒµä»¶'
            },
            role: {
              type: 'string',
              enum: ['user', 'admin'],
              description: 'ç”¨æˆ¶è§’è‰²'
            },
            department: {
              type: 'string',
              description: 'éƒ¨é–€'
            },
            avatar_url: {
              type: 'string',
              description: 'é ­åƒURL'
            },
            is_active: {
              type: 'boolean',
              description: 'æ˜¯å¦å•Ÿç”¨'
            },
            created_at: {
              type: 'string',
              format: 'date-time',
              description: 'å‰µå»ºæ™‚é–“'
            }
          }
        },
        Conversation: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: 'å°è©±ID'
            },
            user_id: {
              type: 'integer',
              description: 'ç”¨æˆ¶ID'
            },
            agent_id: {
              type: 'integer',
              nullable: true,
              description: 'æ™ºèƒ½é«”ID'
            },
            model_id: {
              type: 'integer',
              description: 'æ¨¡å‹ID'
            },
            title: {
              type: 'string',
              description: 'å°è©±æ¨™é¡Œ'
            },
            message_count: {
              type: 'integer',
              description: 'è¨Šæ¯æ•¸é‡'
            },
            total_tokens: {
              type: 'integer',
              description: 'ç¸½tokenæ•¸'
            },
            total_cost: {
              type: 'number',
              format: 'float',
              description: 'ç¸½è²»ç”¨'
            },
            created_at: {
              type: 'string',
              format: 'date-time',
              description: 'å‰µå»ºæ™‚é–“'
            },
            updated_at: {
              type: 'string',
              format: 'date-time',
              description: 'æ›´æ–°æ™‚é–“'
            },
            agent_name: {
              type: 'string',
              description: 'æ™ºèƒ½é«”åç¨±'
            },
            model_name: {
              type: 'string',
              description: 'æ¨¡å‹åç¨±'
            }
          }
        },
        Message: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: 'è¨Šæ¯ID'
            },
            conversation_id: {
              type: 'integer',
              description: 'å°è©±ID'
            },
            role: {
              type: 'string',
              enum: ['user', 'assistant', 'system'],
              description: 'è§’è‰²'
            },
            content: {
              type: 'string',
              description: 'è¨Šæ¯å…§å®¹'
            },
            attachments: {
              type: 'array',
              items: {
                type: 'object',
                properties: {
                  type: {
                    type: 'string',
                    description: 'é™„ä»¶é¡å‹'
                  },
                  url: {
                    type: 'string',
                    description: 'é™„ä»¶URL'
                  },
                  name: {
                    type: 'string',
                    description: 'é™„ä»¶åç¨±'
                  },
                  size: {
                    type: 'integer',
                    description: 'é™„ä»¶å¤§å°'
                  }
                }
              },
              description: 'é™„ä»¶åˆ—è¡¨'
            },
            tokens_used: {
              type: 'integer',
              description: 'ä½¿ç”¨çš„tokenæ•¸'
            },
            cost: {
              type: 'number',
              format: 'float',
              description: 'è²»ç”¨'
            },
            created_at: {
              type: 'string',
              format: 'date-time',
              description: 'å‰µå»ºæ™‚é–“'
            }
          }
        },
        Agent: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: 'æ™ºèƒ½é«”ID'
            },
            name: {
              type: 'string',
              description: 'æ™ºèƒ½é«”åç¨±'
            },
            display_name: {
              type: 'string',
              description: 'é¡¯ç¤ºåç¨±'
            },
            description: {
              type: 'string',
              description: 'æè¿°'
            },
            avatar_url: {
              type: 'string',
              description: 'é ­åƒURL'
            },
            system_prompt: {
              type: 'string',
              description: 'ç³»çµ±æç¤ºè©'
            },
            model_id: {
              type: 'integer',
              description: 'é—œè¯æ¨¡å‹ID'
            },
            capabilities: {
              type: 'object',
              description: 'èƒ½åŠ›é…ç½®'
            },
            is_active: {
              type: 'boolean',
              description: 'æ˜¯å¦å•Ÿç”¨'
            },
            usage_count: {
              type: 'integer',
              description: 'ä½¿ç”¨æ¬¡æ•¸'
            }
          }
        },
        AIModel: {
          type: 'object',
          properties: {
            id: {
              type: 'integer',
              description: 'æ¨¡å‹ID'
            },
            name: {
              type: 'string',
              description: 'æ¨¡å‹åç¨±'
            },
            display_name: {
              type: 'string',
              description: 'é¡¯ç¤ºåç¨±'
            },
            model_type: {
              type: 'string',
              enum: ['ollama', 'gemini'],
              description: 'æ¨¡å‹é¡å‹'
            },
            model_id: {
              type: 'string',
              description: 'æ¨¡å‹æ¨™è­˜ç¬¦'
            },
            endpoint_url: {
              type: 'string',
              description: 'ç«¯é»URL'
            },
            is_active: {
              type: 'boolean',
              description: 'æ˜¯å¦å•Ÿç”¨'
            },
            is_multimodal: {
              type: 'boolean',
              description: 'æ˜¯å¦æ”¯æ´å¤šæ¨¡æ…‹'
            },
            max_tokens: {
              type: 'integer',
              description: 'æœ€å¤§tokenæ•¸'
            }
          }
        },
        Pagination: {
          type: 'object',
          properties: {
            page: {
              type: 'integer',
              description: 'ç•¶å‰é ç¢¼'
            },
            limit: {
              type: 'integer',
              description: 'æ¯é æ•¸é‡'
            },
            total: {
              type: 'integer',
              description: 'ç¸½è¨˜éŒ„æ•¸'
            },
            totalPages: {
              type: 'integer',
              description: 'ç¸½é æ•¸'
            }
          }
        },
        Error: {
          type: 'object',
          properties: {
            success: {
              type: 'boolean',
              example: false
            },
            message: {
              type: 'string',
              description: 'éŒ¯èª¤è¨Šæ¯'
            },
            code: {
              type: 'string',
              description: 'éŒ¯èª¤ä»£ç¢¼'
            },
            details: {
              type: 'object',
              description: 'éŒ¯èª¤è©³æƒ…'
            }
          }
        }
      }
    }
  },
  apis: ['./src/routes/*.js'] // æƒæè·¯ç”±æ–‡ä»¶ä¸­çš„è¨»é‡‹
};

const specs = swaggerJsdoc(options);

module.exports = {
  specs,
  swaggerUi,
  setup: swaggerUi.setup(specs, {
    explorer: true,
    customCss: '.swagger-ui .topbar { display: none }',
    customSiteTitle: 'sfda_nexus API æ–‡æª”'
  })
};
`````

## ğŸ“Š ç›£æ§èˆ‡æ—¥èªŒ

### **æ—¥èªŒé…ç½®**

```javascript
// utils/logger.js
const winston = require("winston");
const path = require("path");

const logDir = process.env.LOG_DIR || "./logs";

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: "sfda-nexus" },
  transports: [
    // éŒ¯èª¤æ—¥èªŒ
    new winston.transports.File({
      filename: path.join(logDir, "error.log"),
      level: "error",
      maxsize: 5242880, // 5MB
      maxFiles: 5,
    }),
    // æ‰€æœ‰æ—¥èªŒ
    new winston.transports.File({
      filename: path.join(logDir, "combined.log"),
      maxsize: 5242880,
      maxFiles: 5,
    }),
    // å¯©è¨ˆæ—¥èªŒ
    new winston.transports.File({
      filename: path.join(logDir, "audit.log"),
      level: "info",
      maxsize: 5242880,
      maxFiles: 10,
    }),
  ],
});

// é–‹ç™¼ç’°å¢ƒä¸‹è¼¸å‡ºåˆ°æ§åˆ¶å°
if (process.env.NODE_ENV !== "production") {
  logger.add(
    new winston.transports.Console({
      format: winston.format.combine(
        winston.format.colorize(),
        winston.format.simple()
      ),
    })
  );
}

module.exports = logger;
```

### **å¥åº·æª¢æŸ¥ç«¯é»**

```javascript
// routes/health.js
const express = require("express");
const router = express.Router();
const db = require("../utils/database");

router.get("/health", async (req, res) => {
  const health = {
    status: "ok",
    timestamp: new Date().toISOString(),
    services: {},
  };

  try {
    // æª¢æŸ¥è³‡æ–™åº«é€£æ¥
    await db.query("SELECT 1");
    health.services.database = "ok";
  } catch (error) {
    health.services.database = "error";
    health.status = "error";
  }

  // æª¢æŸ¥ Ollama é€£æ¥
  try {
    const response = await axios.get(`${process.env.OLLAMA_BASE_URL}/api/tags`);
    health.services.ollama = response.status === 200 ? "ok" : "error";
  } catch (error) {
    health.services.ollama = "error";
  }

  const statusCode = health.status === "ok" ? 200 : 503;
  res.status(statusCode).json(health);
});

module.exports = router;
```

## ğŸ§ª æ¸¬è©¦ç­–ç•¥

### **æ¸¬è©¦çµæ§‹**

```
tests/
â”œâ”€â”€ unit/                    # å–®å…ƒæ¸¬è©¦
â”‚   â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ models/
â”‚   â””â”€â”€ utils/
â”œâ”€â”€ integration/             # æ•´åˆæ¸¬è©¦
â”‚   â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ database/
â”‚   â””â”€â”€ websocket/
â”œâ”€â”€ e2e/                     # ç«¯åˆ°ç«¯æ¸¬è©¦
â”‚   â”œâ”€â”€ auth.test.js
â”‚   â”œâ”€â”€ chat.test.js
â”‚   â””â”€â”€ admin.test.js
â”œâ”€â”€ fixtures/                # æ¸¬è©¦æ•¸æ“š
â”‚   â”œâ”€â”€ users.json
â”‚   â”œâ”€â”€ models.json
â”‚   â””â”€â”€ conversations.json
â””â”€â”€ setup/                   # æ¸¬è©¦è¨­ç½®
    â”œâ”€â”€ database.js
    â”œâ”€â”€ server.js
    â””â”€â”€ cleanup.js
```

### **æ¸¬è©¦ç¯„ä¾‹**

```javascript
// tests/integration/api/chat.test.js
const request = require("supertest");
const app = require("../../../server");
const db = require("../../../src/utils/database");

describe("Chat API", () => {
  let authToken;
  let userId;

  beforeAll(async () => {
    // å‰µå»ºæ¸¬è©¦ç”¨æˆ¶ä¸¦ç²å–token
    const response = await request(app).post("/api/auth/login").send({
      username: "testuser",
      password: "testpass",
    });

    authToken = response.body.data.token;
    userId = response.body.data.user.id;
  });

  afterAll(async () => {
    // æ¸…ç†æ¸¬è©¦æ•¸æ“š
    await db.query(
      "DELETE FROM messages WHERE conversation_id IN (SELECT id FROM conversations WHERE user_id = ?)",
      [userId]
    );
    await db.query("DELETE FROM conversations WHERE user_id = ?", [userId]);
  });

  describe("POST /api/chat/conversations", () => {
    it("should create a new conversation", async () => {
      const response = await request(app)
        .post("/api/chat/conversations")
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          model_id: 1,
          title: "Test Conversation",
        });

      expect(response.status).toBe(201);
      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty("id");
      expect(response.body.data.title).toBe("Test Conversation");
    });

    it("should return 400 for invalid model_id", async () => {
      const response = await request(app)
        .post("/api/chat/conversations")
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          model_id: 999,
          title: "Test Conversation",
        });

      expect(response.status).toBe(400);
      expect(response.body.success).toBe(false);
    });
  });

  describe("POST /api/chat/conversations/:id/messages", () => {
    let conversationId;

    beforeEach(async () => {
      const response = await request(app)
        .post("/api/chat/conversations")
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          model_id: 1,
          title: "Test Conversation",
        });

      conversationId = response.body.data.id;
    });

    it("should send a message and receive AI response", async () => {
      const response = await request(app)
        .post(`/api/chat/conversations/${conversationId}/messages`)
        .set("Authorization", `Bearer ${authToken}`)
        .send({
          content: "Hello, how are you?",
        });

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty("userMessage");
      expect(response.body.data).toHaveProperty("assistantMessage");
      expect(response.body.data.userMessage.content).toBe(
        "Hello, how are you?"
      );
    });
  });
});
```

## ğŸ“ˆ æ€§èƒ½å„ªåŒ–å»ºè­°

### **è³‡æ–™åº«å„ªåŒ–**

- æ·»åŠ é©ç•¶çš„ç´¢å¼•
- ä½¿ç”¨é€£æ¥æ± 
- å¯¦æ–½æŸ¥è©¢å¿«å–
- å®šæœŸæ¸…ç†èˆŠæ•¸æ“š

### **API å„ªåŒ–**

- å¯¦æ–½åˆ†é 
- ä½¿ç”¨å£“ç¸®ä¸­é–“ä»¶
- æ·»åŠ å¿«å–å±¤ (Redis)
- API é™æµ

### **å‰ç«¯å„ªåŒ–**

- çµ„ä»¶æ‡¶åŠ è¼‰
- åœ–ç‰‡å£“ç¸®èˆ‡ CDN
- æ‰“åŒ…å„ªåŒ–
- æœå‹™ç«¯æ¸²æŸ“ (å¯é¸)

---

## ğŸ”’ å®‰å…¨æ€§è€ƒæ…®

### **èªè­‰èˆ‡æˆæ¬Š**

- JWT token éæœŸæ©Ÿåˆ¶
- è§’è‰²æ¬Šé™æ§åˆ¶
- API é™æµ
- è¼¸å…¥é©—è­‰èˆ‡æ¸…ç†

### **æ•¸æ“šå®‰å…¨**

- API Key åŠ å¯†å­˜å„²
- æ•æ„Ÿæ•¸æ“šè„«æ•
- SQL æ³¨å…¥é˜²è­·
- XSS é˜²è­·

### **ç³»çµ±å®‰å…¨**

- HTTPS å¼·åˆ¶
- CORS é…ç½®
- å®‰å…¨æ¨™é ­è¨­ç½®
- å®šæœŸå®‰å…¨æ›´æ–°
