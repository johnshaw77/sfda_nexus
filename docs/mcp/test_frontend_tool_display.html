<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0" />
    <title>å·¥å…·çµæœé¡¯ç¤ºæ¸¬è©¦</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .test-message {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin: 16px 0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      .metadata-display {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 12px;
        margin: 12px 0;
      }
      .json-display {
        background: #263238;
        color: #eeffff;
        padding: 12px;
        border-radius: 6px;
        font-family: "Monaco", "Menlo", monospace;
        font-size: 14px;
        overflow-x: auto;
      }
      .success {
        color: #52c41a;
      }
      .error {
        color: #ff4d4f;
      }
      .tool-section {
        border-left: 4px solid #1890ff;
        padding-left: 12px;
        margin: 16px 0;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ› ï¸ MCP å·¥å…·çµæœé¡¯ç¤ºæ¸¬è©¦</h1>

    <div class="test-message">
      <h2>æ¸¬è©¦å ´æ™¯ï¼šå“¡å·¥è³‡æ–™æŸ¥è©¢æˆåŠŸ</h2>
      <p><strong>åŸå§‹å¾Œç«¯æ•¸æ“šçµæ§‹ï¼š</strong></p>
      <div class="metadata-display">
        <h3>metadata.tool_calls:</h3>
        <div
          class="json-display"
          id="tool-calls-display"></div>

        <h3>metadata.tool_results:</h3>
        <div
          class="json-display"
          id="tool-results-display"></div>
      </div>

      <div class="tool-section">
        <h3>å‰ç«¯è½‰æ›å¾Œçš„æ•¸æ“šçµæ§‹ï¼š</h3>
        <div
          class="json-display"
          id="effective-tool-calls-display"></div>
      </div>
    </div>

    <script>
      // æ¨¡æ“¬å¾Œç«¯è¿”å›çš„æ•¸æ“š
      const mockMessage = {
        id: 1008,
        role: "assistant",
        content: "å¥½çš„ï¼Œæˆ‘æœƒä½¿ç”¨ `get_employee_info` å·¥å…·æŸ¥è©¢å“¡å·¥ A123456...",
        metadata: {
          tool_calls: [
            {
              name: "get_employee_info",
              format: "function",
              parameters: {
                employeeId: "A123456",
              },
            },
          ],
          tool_results: [
            {
              data: {
                data: {
                  basic: {
                    name: "å¼µå°æ˜",
                    gender: "ç”·",
                    hireDate: "2020-03-01",
                    birthDate: "1990-05-15",
                    employeeId: "A123456",
                    nationalId: "A123456789",
                    englishName: "Ming Zhang",
                  },
                  contact: {
                    email: "ming.zhang@company.com",
                    phone: "0912-345-678",
                    address: "å°åŒ—å¸‚ä¿¡ç¾©å€å¿ å­æ±è·¯äº”æ®µ123è™Ÿ",
                    emergencyContact: {
                      name: "å¼µåª½åª½",
                      phone: "0987-654-321",
                      relationship: "æ¯è¦ª",
                    },
                  },
                  position: {
                    jobLevel: "P5",
                    jobTitle: "è³‡æ·±è»Ÿé«”å·¥ç¨‹å¸«",
                    jobFamily: "æŠ€è¡“é¡",
                    reportingManager: "ç‹å·¥ç¨‹å¸«",
                    reportingManagerId: "A123010",
                  },
                  department: {
                    manager: "æå¤§è¯",
                    location: "å°åŒ—ç¸½éƒ¨ 8F",
                    managerId: "A123001",
                    departmentId: "IT001",
                    departmentCode: "IT",
                    departmentName: "è³‡è¨ŠæŠ€è¡“éƒ¨",
                  },
                },
                fields: ["basic", "contact", "department", "position"],
                timestamp: "2025-06-11T13:48:57.259Z",
                employeeId: "A123456",
              },
              module: "hr",
              success: true,
              tool_id: 127,
              version: "1.0.0",
              timestamp: "2025-06-11T13:48:57.270Z",
              tool_name: "get_employee_info",
              from_cache: false,
              execution_id: "get_employee_info-1749649737112-wc91ay76o",
              service_name: "Hr æœå‹™",
              execution_time: 149,
            },
          ],
          has_tool_calls: true,
        },
      };

      // æ¨¡æ“¬å‰ç«¯çš„ effectiveToolCalls è¨ˆç®—é‚è¼¯
      function computeEffectiveToolCalls(message) {
        const toolCalls =
          message.metadata?.tool_calls || message.tool_calls || [];
        const toolResults = message.metadata?.tool_results || [];

        if (toolCalls.length === 0) {
          return [];
        }

        return toolCalls.map((toolCall, index) => {
          const result = toolResults[index];

          return {
            // å·¥å…·èª¿ç”¨åŸºæœ¬ä¿¡æ¯
            toolName: toolCall.name || result?.tool_name || "unknown",
            name: toolCall.name || result?.tool_name,
            format: toolCall.format || "function",
            arguments: toolCall.parameters || {},

            // åŸ·è¡Œçµæœ
            success: result?.success || false,
            result: result?.data || {},
            error: result?.error || null,
            executionTime: result?.execution_time || 0,

            // å…ƒæ•¸æ“š
            metadata: {
              timestamp: result?.timestamp,
              version: result?.version,
              executionId: result?.execution_id,
              serviceName: result?.service_name,
              module: result?.module,
            },

            // èª¿è©¦ä¿¡æ¯
            details: result,
          };
        });
      }

      // é¡¯ç¤ºæ•¸æ“š
      document.getElementById("tool-calls-display").textContent =
        JSON.stringify(mockMessage.metadata.tool_calls, null, 2);

      document.getElementById("tool-results-display").textContent =
        JSON.stringify(mockMessage.metadata.tool_results, null, 2);

      const effectiveToolCalls = computeEffectiveToolCalls(mockMessage);
      document.getElementById("effective-tool-calls-display").textContent =
        JSON.stringify(effectiveToolCalls, null, 2);

      console.log("âœ… æ¸¬è©¦æ•¸æ“šçµæ§‹:", {
        original: mockMessage.metadata,
        transformed: effectiveToolCalls,
      });
    </script>
  </body>
</html>
