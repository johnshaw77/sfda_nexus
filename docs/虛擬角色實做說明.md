æ™ºèƒ½é«”/è™›æ“¬è§’è‰²åœ¨ AI å°è©±ä¸­çš„å¯¦ç¾æ©Ÿåˆ¶ï¼š

## ğŸ¤– æ™ºèƒ½é«”å¯¦ç¾åŸç†

### æ ¸å¿ƒæ¦‚å¿µ

æ™ºèƒ½é«”æœ¬è³ªä¸Šæ˜¯é€šé **System Promptï¼ˆç³»çµ±æç¤ºè©ï¼‰** ä¾†å®šç¾© AI çš„è§’è‰²ã€æ€§æ ¼å’Œè¡Œç‚ºæ¨¡å¼ã€‚

## ğŸ”§ æŠ€è¡“å¯¦ç¾æµç¨‹

### 1. **System Prompt æ³¨å…¥**

```javascript
// ç•¶ç”¨æˆ¶é¸æ“‡æ™ºèƒ½é«”æ™‚ï¼Œç³»çµ±æœƒæ³¨å…¥å°æ‡‰çš„ system prompt
const conversation = [
  {
    role: "system",
    content: agent.system_prompt, // å¾è³‡æ–™åº«ç²å–æ™ºèƒ½é«”çš„ç³»çµ±æç¤ºè©
  },
  {
    role: "user",
    content: "ç”¨æˆ¶çš„å¯¦éš›å•é¡Œ",
  },
];

// ç™¼é€çµ¦AIæ¨¡å‹
const response = await aiModel.chat(conversation);
```

### 2. **æ™ºèƒ½é«”é…ç½®ç¤ºä¾‹**

```sql
-- è³‡æ–™åº«ä¸­çš„æ™ºèƒ½é«”è¨˜éŒ„
INSERT INTO agents (name, display_name, system_prompt) VALUES
(
  'customer_service',
  'å®¢æœåŠ©æ‰‹å°ç¾',
  'ä½ æ˜¯ä¸€ä½å°ˆæ¥­ã€å‹å–„çš„å®¢æœåŠ©æ‰‹å°ç¾ã€‚ä½ çš„ç‰¹é»æ˜¯ï¼š
  - ç¸½æ˜¯ä¿æŒç¦®è²Œå’Œè€å¿ƒ
  - ç”¨æº«æš–çš„èªèª¿å›æ‡‰å®¢æˆ¶
  - æœƒä¸»å‹•è©¢å•å®¢æˆ¶éœ€æ±‚
  - æ“…é•·è§£æ±ºå•é¡Œå’Œæä¾›å»ºè­°
  - èªªè©±æ™‚æœƒé©ç•¶ä½¿ç”¨è¡¨æƒ…ç¬¦è™ŸğŸ˜Š
  è«‹ä»¥é€™å€‹è§’è‰²èˆ‡ç”¨æˆ¶å°è©±ã€‚'
);
```

## ğŸ’¬ å¯¦éš›å°è©±å¯¦ç¾

### å‰ç«¯å¯¦ç¾

```vue
<template>
  <div class="chat-container">
    <!-- æ™ºèƒ½é«”é¸æ“‡å™¨ -->
    <AgentSelector @agent-selected="onAgentSelected" />

    <!-- èŠå¤©ç•Œé¢ -->
    <ChatWindow
      :agent="selectedAgent"
      :messages="messages"
      @send-message="sendMessage" />
  </div>
</template>

<script setup>
import { ref } from "vue";
import { useChatStore } from "@/stores/chat";

const chatStore = useChatStore();
const selectedAgent = ref(null);
const messages = ref([]);

// é¸æ“‡æ™ºèƒ½é«”
const onAgentSelected = async (agent) => {
  selectedAgent.value = agent;

  // å‰µå»ºæ–°å°è©±ï¼Œé—œè¯æ™ºèƒ½é«”
  await chatStore.createConversation(agent.id);

  // é¡¯ç¤ºæ™ºèƒ½é«”çš„æ­¡è¿è¨Šæ¯
  if (agent.welcome_message) {
    messages.value.push({
      role: "assistant",
      content: agent.welcome_message,
      timestamp: new Date(),
    });
  }
};

// ç™¼é€è¨Šæ¯
const sendMessage = async (content) => {
  // æ·»åŠ ç”¨æˆ¶è¨Šæ¯
  messages.value.push({
    role: "user",
    content,
    timestamp: new Date(),
  });

  // ç™¼é€åˆ°å¾Œç«¯ï¼ŒåŒ…å«æ™ºèƒ½é«”ä¿¡æ¯
  const response = await chatStore.sendMessage({
    content,
    agentId: selectedAgent.value?.id,
  });

  // æ·»åŠ AIå›æ‡‰
  messages.value.push({
    role: "assistant",
    content: response.content,
    timestamp: new Date(),
  });
};
</script>
```

### å¾Œç«¯å¯¦ç¾

```javascript
// èŠå¤©APIå¯¦ç¾
app.post("/api/conversations/:id/messages", async (req, res) => {
  const { content } = req.body;
  const conversationId = req.params.id;

  try {
    // 1. ç²å–å°è©±ä¿¡æ¯ï¼ˆåŒ…å«æ™ºèƒ½é«”ï¼‰
    const conversation = await Conversation.findByPk(conversationId, {
      include: [{ model: Agent, include: [AIModel] }, { model: User }],
    });

    // 2. æ§‹å»ºå°è©±æ­·å²
    const messages = await Message.findAll({
      where: { conversation_id: conversationId },
      order: [["created_at", "ASC"]],
      limit: 20, // é™åˆ¶ä¸Šä¸‹æ–‡é•·åº¦
    });

    // 3. æ§‹å»ºAIè«‹æ±‚
    const aiMessages = [];

    // æ³¨å…¥ç³»çµ±æç¤ºè©ï¼ˆæ™ºèƒ½é«”è§’è‰²ï¼‰
    if (conversation.Agent) {
      aiMessages.push({
        role: "system",
        content: conversation.Agent.system_prompt,
      });
    }

    // æ·»åŠ æ­·å²å°è©±
    messages.forEach((msg) => {
      aiMessages.push({
        role: msg.role,
        content: msg.content,
      });
    });

    // æ·»åŠ ç•¶å‰ç”¨æˆ¶è¨Šæ¯
    aiMessages.push({
      role: "user",
      content: content,
    });

    // 4. èª¿ç”¨AIæ¨¡å‹
    const aiResponse = await callAIModel(
      conversation.Agent.AIModel,
      aiMessages
    );

    // 5. ä¿å­˜è¨Šæ¯åˆ°è³‡æ–™åº«
    await Message.bulkCreate([
      {
        conversation_id: conversationId,
        role: "user",
        content: content,
      },
      {
        conversation_id: conversationId,
        role: "assistant",
        content: aiResponse.content,
        tokens_used: aiResponse.tokens,
      },
    ]);

    res.json({
      content: aiResponse.content,
      tokens: aiResponse.tokens,
    });
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// AIæ¨¡å‹èª¿ç”¨å‡½æ•¸
async function callAIModel(model, messages) {
  if (model.model_type === "ollama") {
    return await callOllama(model, messages);
  } else if (model.model_type === "gemini") {
    return await callGemini(model, messages);
  }
}

// Ollamaèª¿ç”¨
async function callOllama(model, messages) {
  const response = await fetch(`${model.endpoint_url}/api/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: model.model_id,
      messages: messages,
      stream: false,
      options: model.parameters || {},
    }),
  });

  const data = await response.json();
  return {
    content: data.message.content,
    tokens: data.eval_count || 0,
  };
}
```

## ğŸ­ æ™ºèƒ½é«”é¡å‹ç¤ºä¾‹

### 1. **å®¢æœåŠ©æ‰‹**

```javascript
const customerServiceAgent = {
  name: "customer_service",
  display_name: "å®¢æœå°ç¾",
  system_prompt: `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„å®¢æœåŠ©æ‰‹å°ç¾ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹é»ï¼š
- å‹å–„ã€è€å¿ƒã€å°ˆæ¥­
- ä¸»å‹•é—œå¿ƒå®¢æˆ¶éœ€æ±‚
- èƒ½å¤ å¿«é€Ÿç†è§£å•é¡Œä¸¦æä¾›è§£æ±ºæ–¹æ¡ˆ
- èªªè©±æº«å’Œï¼Œé©ç•¶ä½¿ç”¨è¡¨æƒ…ç¬¦è™Ÿ
- é‡åˆ°ç„¡æ³•è§£æ±ºçš„å•é¡Œæœƒä¸»å‹•è½‰æ¥äººå·¥å®¢æœ

è«‹ä»¥é€™å€‹è§’è‰²èˆ‡å®¢æˆ¶å°è©±ï¼Œå¹«åŠ©ä»–å€‘è§£æ±ºå•é¡Œã€‚`,
  welcome_message:
    "æ‚¨å¥½ï¼æˆ‘æ˜¯å®¢æœå°ç¾ğŸ˜Š å¾ˆé«˜èˆˆç‚ºæ‚¨æœå‹™ï¼è«‹å•æœ‰ä»€éº¼å¯ä»¥å¹«åŠ©æ‚¨çš„å—ï¼Ÿ",
};
```

### 2. **æŠ€è¡“å°ˆå®¶**

```javascript
const techExpertAgent = {
  name: "tech_expert",
  display_name: "æŠ€è¡“å°ˆå®¶è€ç‹",
  system_prompt: `ä½ æ˜¯ä¸€ä½è³‡æ·±çš„æŠ€è¡“å°ˆå®¶è€ç‹ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹é»ï¼š
- æ“æœ‰è±å¯Œçš„ç¨‹å¼é–‹ç™¼å’Œç³»çµ±æ¶æ§‹ç¶“é©—
- æ“…é•·è§£é‡‹è¤‡é›œçš„æŠ€è¡“æ¦‚å¿µ
- æœƒæä¾›å…·é«”çš„ä»£ç¢¼ç¤ºä¾‹å’Œè§£æ±ºæ–¹æ¡ˆ
- èªªè©±ç›´æ¥ã€é‚è¼¯æ¸…æ™°
- å–œæ­¡åˆ†äº«æœ€ä½³å¯¦è¸å’Œç¶“é©—

è«‹ä»¥é€™å€‹è§’è‰²å›ç­”æŠ€è¡“ç›¸é—œå•é¡Œã€‚`,
  welcome_message: "å—¨ï¼æˆ‘æ˜¯æŠ€è¡“å°ˆå®¶è€ç‹ ğŸ’» æœ‰ä»€éº¼æŠ€è¡“å•é¡Œéœ€è¦è¨è«–å—ï¼Ÿ",
};
```

### 3. **å‰µæ„å¯«æ‰‹**

```javascript
const creativeWriterAgent = {
  name: "creative_writer",
  display_name: "å‰µæ„å¯«æ‰‹å°æ–‡",
  system_prompt: `ä½ æ˜¯ä¸€ä½å¯Œæœ‰å‰µæ„çš„å¯«æ‰‹å°æ–‡ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹é»ï¼š
- æƒ³è±¡åŠ›è±å¯Œï¼Œæ–‡ç­†å„ªç¾
- æ“…é•·å„ç¨®æ–‡é«”å‰µä½œï¼ˆå°èªªã€è©©æ­Œã€åŠ‡æœ¬ç­‰ï¼‰
- èƒ½å¤ æ ¹æ“šéœ€æ±‚èª¿æ•´å¯«ä½œé¢¨æ ¼
- å–œæ­¡ä½¿ç”¨ç”Ÿå‹•çš„æ¯”å–»å’Œæè¿°
- æœƒä¸»å‹•è©¢å•å‰µä½œéœ€æ±‚å’Œåå¥½

è«‹ä»¥é€™å€‹è§’è‰²å”åŠ©ç”¨æˆ¶é€²è¡Œå‰µæ„å¯«ä½œã€‚`,
  welcome_message: "ä½ å¥½ï¼æˆ‘æ˜¯å‰µæ„å¯«æ‰‹å°æ–‡ âœï¸ ä»Šå¤©æƒ³å‰µä½œä»€éº¼æœ‰è¶£çš„å…§å®¹å‘¢ï¼Ÿ",
};
```

## ğŸ”„ å‹•æ…‹åƒæ•¸èª¿æ•´

```javascript
// ä¸åŒæ™ºèƒ½é«”å¯ä»¥æœ‰ä¸åŒçš„AIåƒæ•¸
const agentParameters = {
  customer_service: {
    temperature: 0.3, // è¼ƒä½æº«åº¦ï¼Œå›ç­”æ›´ç©©å®š
    max_tokens: 500,
  },
  creative_writer: {
    temperature: 0.8, // è¼ƒé«˜æº«åº¦ï¼Œæ›´æœ‰å‰µæ„
    max_tokens: 1000,
  },
  tech_expert: {
    temperature: 0.2, // æœ€ä½æº«åº¦ï¼ŒæŠ€è¡“ç­”æ¡ˆè¦æº–ç¢º
    max_tokens: 800,
  },
};
```

## ğŸ“Š æ™ºèƒ½é«”ç®¡ç†ç•Œé¢

```vue
<!-- ç®¡ç†å“¡é…ç½®æ™ºèƒ½é«” -->
<template>
  <div class="agent-config">
    <a-form @submit="saveAgent">
      <a-form-item label="æ™ºèƒ½é«”åç¨±">
        <a-input v-model="agent.display_name" />
      </a-form-item>

      <a-form-item label="è§’è‰²æè¿°">
        <a-textarea v-model="agent.description" />
      </a-form-item>

      <a-form-item label="ç³»çµ±æç¤ºè©">
        <a-textarea
          v-model="agent.system_prompt"
          :rows="10"
          placeholder="å®šç¾©AIçš„è§’è‰²ã€æ€§æ ¼å’Œè¡Œç‚º..." />
      </a-form-item>

      <a-form-item label="æ­¡è¿è¨Šæ¯">
        <a-textarea v-model="agent.welcome_message" />
      </a-form-item>

      <a-form-item label="AIæ¨¡å‹">
        <a-select v-model="agent.model_id">
          <a-select-option
            v-for="model in aiModels"
            :key="model.id"
            :value="model.id">
            {{ model.display_name }}
          </a-select-option>
        </a-select>
      </a-form-item>

      <a-button
        type="primary"
        html-type="submit">
        ä¿å­˜æ™ºèƒ½é«”
      </a-button>
    </a-form>
  </div>
</template>
```

## ğŸ¯ é—œéµè¦é»

1. **System Prompt æ˜¯æ ¸å¿ƒ**: é€šéç²¾å¿ƒè¨­è¨ˆçš„ç³»çµ±æç¤ºè©å®šç¾©æ™ºèƒ½é«”çš„"äººæ ¼"
2. **ä¸Šä¸‹æ–‡ç®¡ç†**: ä¿æŒå°è©±æ­·å²ï¼Œè®“æ™ºèƒ½é«”èƒ½å¤ è¨˜ä½ä¹‹å‰çš„å°è©±
3. **åƒæ•¸èª¿æ•´**: ä¸åŒè§’è‰²ä½¿ç”¨ä¸åŒçš„ AI åƒæ•¸ï¼ˆæº«åº¦ã€æœ€å¤§ token ç­‰ï¼‰
4. **æ­¡è¿è¨Šæ¯**: è®“ç”¨æˆ¶ç«‹å³æ„Ÿå—åˆ°æ™ºèƒ½é«”çš„å€‹æ€§
5. **æŒä¹…åŒ–å­˜å„²**: å°‡æ™ºèƒ½é«”é…ç½®å­˜å„²åœ¨è³‡æ–™åº«ä¸­ï¼Œä¾¿æ–¼ç®¡ç†å’Œå¾©ç”¨

é€™æ¨£å¯¦ç¾çš„æ™ºèƒ½é«”æœƒè®“ç”¨æˆ¶æ„Ÿè¦ºåƒæ˜¯åœ¨å’Œä¸åŒæ€§æ ¼ã€å°ˆæ¥­èƒŒæ™¯çš„"äºº"å°è©±
