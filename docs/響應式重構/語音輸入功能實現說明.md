# 語音輸入功能實現說明

## 概述

在 SFDA Nexus 聊天系統中實現了基於 VueUse `useSpeechRecognition` 的語音輸入功能，支援繁體中文語音識別，提供流暢的語音轉文字體驗。

## 技術實現

### 1. 核心依賴

```javascript
import { useSpeechRecognition } from "@vueuse/core";
```

### 2. 語音識別配置

```javascript
const {
  isSupported: speechSupported,
  isListening,
  isFinal,
  result: speechResult,
  start: startSpeechRecognition,
  stop: stopSpeechRecognition,
} = useSpeechRecognition({
  lang: "zh-TW", // 繁體中文
  interimResults: true, // 即時結果
  continuous: true, // 持續監聽
});
```

### 3. 主要功能

#### 語音輸入控制

- **開始/停止**: 點擊麥克風按鈕切換語音識別狀態
- **自動停止**: 識別完成後自動停止監聽
- **錯誤處理**: 瀏覽器不支援時顯示友好提示

#### 結果處理

- **即時更新**: 語音識別過程中即時更新輸入框內容
- **去重機制**: 避免重複添加相同的識別結果
- **智能合併**: 將新的語音結果與現有文字智能合併

#### 視覺回饋

- **按鈕動畫**: 監聽時顯示紅色脈動動畫
- **輸入框效果**: 監聽時輸入框邊框發光
- **動態提示**: placeholder 顯示當前狀態

## 代碼實現

### 語音輸入處理函數

```javascript
const handleVoiceInput = () => {
  if (!speechSupported.value) {
    message.error(
      "您的瀏覽器不支援語音識別功能，請使用 Chrome、Edge 或 Safari 瀏覽器"
    );
    return;
  }

  if (isListening.value) {
    stopSpeechRecognition();
    message.success("語音輸入已停止");
  } else {
    try {
      startSpeechRecognition();
      message.success("開始語音輸入，請說話...", 3);
    } catch (error) {
      console.error("語音識別啟動失敗:", error);
      message.error("語音識別啟動失敗，請檢查麥克風權限");
    }
  }
};
```

### 結果監聽處理

```javascript
// 監聽語音識別結果
watch(speechResult, (newResult) => {
  if (newResult && newResult !== lastSpeechResult.value) {
    if (isFinal.value) {
      messageText.value = newResult;
      lastSpeechResult.value = newResult;
    } else {
      const baseText = messageText.value
        .replace(lastSpeechResult.value, "")
        .trim();
      messageText.value = baseText ? `${baseText} ${newResult}` : newResult;
      lastSpeechResult.value = newResult;
    }
  }
});

// 監聽完成狀態
watch(isFinal, (final) => {
  if (final && isListening.value && speechResult.value) {
    lastSpeechResult.value = "";
    setTimeout(() => {
      if (isListening.value) {
        stopSpeechRecognition();
        message.success("語音輸入完成");
        // 自動聚焦到輸入框
      }
    }, 1500);
  }
});
```

## UI 組件更新

### 語音輸入按鈕

```vue
<a-button
  type="text"
  size="small"
  :disabled="!speechSupported || sending || optimizingPrompt"
  :class="{ 'voice-active': isListening }"
  @click="handleVoiceInput">
  <Mic :size="14" />
</a-button>
```

### 動態提示

```vue
:placeholder=" isListening ? '🎤 正在監聽語音輸入...' : `向
${agent?.display_name || 'AI助手'} 發送消息...` "
```

## CSS 樣式

### 語音按鈕動畫

```css
.voice-active {
  background: rgba(255, 77, 79, 0.1) !important;
  color: #ff4d4f !important;
  border-color: rgba(255, 77, 79, 0.3) !important;
  animation: voice-pulse 1.5s infinite;
}

@keyframes voice-pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(255, 77, 79, 0.4);
  }
  70% {
    box-shadow: 0 0 0 8px rgba(255, 77, 79, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(255, 77, 79, 0);
  }
}
```

### 輸入框發光效果

```css
.voice-listening {
  background: rgba(255, 77, 79, 0.05) !important;
  border-color: rgba(255, 77, 79, 0.3) !important;
  animation: voice-input-glow 2s infinite;
}

@keyframes voice-input-glow {
  0%,
  100% {
    border-color: rgba(255, 77, 79, 0.3);
    box-shadow: 0 0 5px rgba(255, 77, 79, 0.2);
  }
  50% {
    border-color: rgba(255, 77, 79, 0.6);
    box-shadow: 0 0 15px rgba(255, 77, 79, 0.4);
  }
}
```

## 瀏覽器支援

### 支援的瀏覽器

- ✅ **Chrome** (推薦) - 完整支援
- ✅ **Edge** - 完整支援
- ✅ **Safari** - 基本支援
- ❌ **Firefox** - 不支援 Web Speech API

### 功能檢測

```javascript
if (!speechSupported.value) {
  message.error(
    "您的瀏覽器不支援語音識別功能，請使用 Chrome、Edge 或 Safari 瀏覽器"
  );
}
```

## 使用流程

1. **點擊語音按鈕**: 用戶點擊麥克風圖標
2. **權限請求**: 瀏覽器請求麥克風權限
3. **開始監聽**: 系統開始語音識別，按鈕顯示脈動動畫
4. **即時顯示**: 語音識別結果即時顯示在輸入框中
5. **自動完成**: 識別完成後自動停止，聚焦輸入框
6. **手動停止**: 用戶可隨時點擊按鈕停止語音輸入

## 錯誤處理

### 常見問題及解決方案

1. **瀏覽器不支援**

   - 提示用戶使用支援的瀏覽器
   - 按鈕顯示為禁用狀態

2. **麥克風權限被拒絕**

   - 顯示權限錯誤提示
   - 引導用戶檢查瀏覽器設置

3. **網路連接問題**
   - 語音識別需要網路連接
   - 提示用戶檢查網路狀態

## 最佳實踐

### 用戶體驗優化

- 提供清晰的視覺反饋
- 支援手動停止功能
- 自動聚焦到輸入框
- 友好的錯誤提示

### 性能優化

- 組件卸載時自動停止語音識別
- 避免重複添加相同結果
- 合理的延遲設置確保完整識別

## 測試驗證

### 功能測試

```javascript
// 運行測試文件
import { runAllTests } from "@/test/test_voice_input.js";
runAllTests();
```

### 手動測試檢查項目

- [ ] 語音按鈕是否正常顯示
- [ ] 點擊後是否開始語音識別
- [ ] 識別結果是否即時更新
- [ ] 完成後是否自動停止
- [ ] 視覺效果是否正常
- [ ] 錯誤處理是否友好

## 未來改進

### 可能的增強功能

1. **多語言支援**: 支援更多語言的語音識別
2. **語音命令**: 支援特定的語音命令操作
3. **離線識別**: 探索離線語音識別方案
4. **語音品質檢測**: 檢測環境噪音和語音品質
5. **個性化調整**: 允許用戶調整識別參數

### 技術優化

1. **更智能的結果合併**: 改進語音結果與現有文字的合併邏輯
2. **更好的錯誤恢復**: 提供更詳細的錯誤信息和恢復建議
3. **性能監控**: 添加語音識別性能監控
4. **A/B 測試**: 測試不同的 UI 設計和交互方式

## 總結

語音輸入功能的實現遵循了 VueUse 的最佳實踐，提供了流暢的語音轉文字體驗。通過合理的錯誤處理、視覺反饋和用戶體驗優化，為用戶提供了便捷的語音輸入方式，特別適合移動設備和無障礙使用場景。
