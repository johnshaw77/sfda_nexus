<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0" />
    <title>å‰ç«¯ SSE è™•ç†æ¸¬è©¦</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        border: 1px solid #ddd;
        padding: 20px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .thinking-content {
        background-color: #f0f8ff;
        border-left: 4px solid #007bff;
        padding: 10px;
        margin: 10px 0;
        white-space: pre-wrap;
      }
      .message-content {
        background-color: #f9f9f9;
        padding: 10px;
        margin: 10px 0;
        white-space: pre-wrap;
      }
      .log {
        background-color: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
        font-size: 12px;
        max-height: 300px;
        overflow-y: auto;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .status.connecting {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
      }
      .status.connected {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ§ª å‰ç«¯ SSE è™•ç†æ¸¬è©¦</h1>

    <div class="container">
      <h2>æ§åˆ¶é¢æ¿</h2>
      <button onclick="startSSETest()">é–‹å§‹ SSE æ¸¬è©¦</button>
      <button onclick="stopSSETest()">åœæ­¢æ¸¬è©¦</button>
      <button onclick="clearLogs()">æ¸…é™¤æ—¥èªŒ</button>
    </div>

    <div class="container">
      <h2>é€£æ¥ç‹€æ…‹</h2>
      <div
        id="status"
        class="status">
        æœªé€£æ¥
      </div>
    </div>

    <div class="container">
      <h2>æ€è€ƒå…§å®¹</h2>
      <div
        id="thinking-content"
        class="thinking-content">
        ç­‰å¾…æ€è€ƒå…§å®¹...
      </div>
    </div>

    <div class="container">
      <h2>æ¶ˆæ¯å…§å®¹</h2>
      <div
        id="message-content"
        class="message-content">
        ç­‰å¾…æ¶ˆæ¯å…§å®¹...
      </div>
    </div>

    <div class="container">
      <h2>èª¿è©¦æ—¥èªŒ</h2>
      <div
        id="log"
        class="log"></div>
    </div>

    <script>
      let eventSource = null;
      let messageContent = "";
      let thinkingContent = "";
      let isAnimating = false;
      let isThinkingAnimating = false;

      function log(message) {
        try {
          const logDiv = document.getElementById("log");
          const timestamp = new Date().toLocaleTimeString();
          logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
          logDiv.scrollTop = logDiv.scrollHeight;

          // åŒæ™‚è¼¸å‡ºåˆ°æ§åˆ¶å°
          console.log(`[${timestamp}] ${message}`);
        } catch (error) {
          console.error("æ—¥èªŒè¨˜éŒ„éŒ¯èª¤:", error);
        }
      }

      function updateStatus(status, className) {
        try {
          const statusDiv = document.getElementById("status");
          statusDiv.textContent = status;
          statusDiv.className = `status ${className}`;
          console.log("ç‹€æ…‹æ›´æ–°:", status);
        } catch (error) {
          console.error("ç‹€æ…‹æ›´æ–°éŒ¯èª¤:", error);
        }
      }

      function updateThinkingContent(content) {
        try {
          const thinkingDiv = document.getElementById("thinking-content");
          thinkingDiv.textContent = content || "ç­‰å¾…æ€è€ƒå…§å®¹...";
          console.log("æ€è€ƒå…§å®¹æ›´æ–°:", content?.length || 0, "å­—ç¬¦");
        } catch (error) {
          console.error("æ€è€ƒå…§å®¹æ›´æ–°éŒ¯èª¤:", error);
        }
      }

      function updateMessageContent(content) {
        try {
          const messageDiv = document.getElementById("message-content");
          messageDiv.textContent = content || "ç­‰å¾…æ¶ˆæ¯å…§å®¹...";
          console.log("æ¶ˆæ¯å…§å®¹æ›´æ–°:", content?.length || 0, "å­—ç¬¦");
        } catch (error) {
          console.error("æ¶ˆæ¯å…§å®¹æ›´æ–°éŒ¯èª¤:", error);
        }
      }

      // æ‰“å­—æ©Ÿå‹•ç•«æ•ˆæœ
      function animateTyping(targetContent, currentContent = "") {
        if (isAnimating) {
          console.log("å‹•ç•«æ­£åœ¨é€²è¡Œä¸­ï¼Œè·³é");
          return;
        }

        console.log(
          "é–‹å§‹æ‰“å­—æ©Ÿå‹•ç•«:",
          currentContent.length,
          "â†’",
          targetContent.length
        );
        isAnimating = true;
        let currentIndex = currentContent.length;

        const typeNextChar = () => {
          try {
            if (currentIndex < targetContent.length) {
              const newContent = targetContent.substring(0, currentIndex + 1);
              updateMessageContent(newContent);
              currentIndex++;

              // 10-40ms éš¨æ©Ÿå»¶é²ï¼Œæ¨¡æ“¬çœŸå¯¦æ‰“å­—
              const delay = Math.random() * 30 + 10;
              setTimeout(typeNextChar, delay);
            } else {
              isAnimating = false;
              log("âœ… æ‰“å­—æ©Ÿå‹•ç•«å®Œæˆ");
              console.log(
                "æ‰“å­—æ©Ÿå‹•ç•«å®Œæˆï¼Œæœ€çµ‚å…§å®¹é•·åº¦:",
                targetContent.length
              );
            }
          } catch (error) {
            console.error("æ‰“å­—æ©Ÿå‹•ç•«éŒ¯èª¤:", error);
            isAnimating = false;
          }
        };

        typeNextChar();
      }

      // æ€è€ƒå…§å®¹æ‰“å­—æ©Ÿå‹•ç•«æ•ˆæœ
      function animateThinkingTyping(targetContent, currentContent = "") {
        if (isThinkingAnimating) {
          console.log("æ€è€ƒå‹•ç•«æ­£åœ¨é€²è¡Œä¸­ï¼Œè·³é");
          return;
        }

        console.log(
          "é–‹å§‹æ€è€ƒå…§å®¹æ‰“å­—æ©Ÿå‹•ç•«:",
          currentContent.length,
          "â†’",
          targetContent.length
        );
        isThinkingAnimating = true;
        let currentIndex = currentContent.length;

        const typeNextChar = () => {
          try {
            if (currentIndex < targetContent.length) {
              const newContent = targetContent.substring(0, currentIndex + 1);
              updateThinkingContent(newContent);
              currentIndex++;

              // æ€è€ƒå…§å®¹ç¨å¾®å¿«ä¸€é»ï¼Œ5-20ms å»¶é²
              const delay = Math.random() * 15 + 5;
              setTimeout(typeNextChar, delay);
            } else {
              isThinkingAnimating = false;
              log("âœ… æ€è€ƒå…§å®¹æ‰“å­—æ©Ÿå‹•ç•«å®Œæˆ");
              console.log("æ€è€ƒå…§å®¹å‹•ç•«å®Œæˆï¼Œæœ€çµ‚é•·åº¦:", targetContent.length);
            }
          } catch (error) {
            console.error("æ€è€ƒå…§å®¹å‹•ç•«éŒ¯èª¤:", error);
            isThinkingAnimating = false;
          }
        };

        typeNextChar();
      }

      function startSSETest() {
        try {
          console.log("=== é–‹å§‹ SSE æ¸¬è©¦ ===");
          log("ğŸ”„ é–‹å§‹ SSE æ¸¬è©¦...");

          updateStatus("æ­£åœ¨é€£æ¥...", "connecting");

          // é‡ç½®å…§å®¹
          messageContent = "";
          thinkingContent = "";
          updateThinkingContent("");
          updateMessageContent("");

          const token =
            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6MSwidXNlcm5hbWUiOiJhZG1pbiIsImVtYWlsIjoiYWRtaW5AZXhhbXBsZS5jb20iLCJyb2xlIjoiYWRtaW4iLCJ0eXBlIjoiYWNjZXNzIiwiaWF0IjoxNzQ5OTgyMzE2LCJleHAiOjE3NTAwNjg3MTYsImF1ZCI6InNmZGEtbmV4dXMtdXNlcnMiLCJpc3MiOiJzZmRhLW5leHVzIn0.QSU8LdNi9a1oFJAu2wOn-Z80Ft-zVHnmEXdWo88PZG8";

          log("ğŸ“¡ ç™¼é€ POST è«‹æ±‚åˆ°å¾Œç«¯...");
          console.log(
            "ç™¼é€è«‹æ±‚åˆ°:",
            "http://localhost:3000/api/chat/conversations/21/messages/stream"
          );

          // ç™¼é€ POST è«‹æ±‚é–‹å§‹ SSE æµ
          fetch(
            "http://localhost:3000/api/chat/conversations/21/messages/stream",
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
                Accept: "text/event-stream",
                "Cache-Control": "no-cache",
              },
              body: JSON.stringify({
                content: "3+3ç­‰æ–¼å¤šå°‘ï¼Ÿå¦‚ä½•å­¸ç¿’ç·¨ç¨‹ï¼Ÿ",
                agent_id: 1,
                model_id: 42, // qwen3:8b
                max_tokens: 4096,
                temperature: 0.7,
              }),
            }
          )
            .then((response) => {
              console.log("æ”¶åˆ°éŸ¿æ‡‰:", response.status, response.statusText);

              if (!response.ok) {
                throw new Error(
                  `HTTP ${response.status}: ${response.statusText}`
                );
              }

              log("âœ… SSE é€£æ¥å»ºç«‹æˆåŠŸï¼Œé–‹å§‹è®€å–æµ...");
              updateStatus("å·²é€£æ¥", "connected");

              const reader = response.body.getReader();
              const decoder = new TextDecoder();
              let buffer = "";
              let eventCount = 0;

              function readStream() {
                reader
                  .read()
                  .then(({ done, value }) => {
                    if (done) {
                      console.log("=== SSE æµçµæŸ ===");
                      log("ğŸ“¡ SSE æµçµæŸ");
                      updateStatus("é€£æ¥å·²é—œé–‰", "error");
                      return;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split("\n");
                    buffer = lines.pop() || "";

                    let currentEventType = null;

                    for (const line of lines) {
                      if (line.startsWith("event: ")) {
                        currentEventType = line.slice(7).trim();
                        continue;
                      }

                      if (line.startsWith("data: ")) {
                        const jsonStr = line.slice(6).trim();

                        if (jsonStr && currentEventType) {
                          try {
                            eventCount++;
                            const data = JSON.parse(jsonStr);
                            console.log(
                              `äº‹ä»¶ ${eventCount}:`,
                              currentEventType,
                              data
                            );
                            handleSSEEvent(data, currentEventType, eventCount);
                            currentEventType = null;
                          } catch (parseError) {
                            console.error(
                              "SSE æ•¸æ“šè§£æéŒ¯èª¤:",
                              parseError,
                              "åŸå§‹æ•¸æ“š:",
                              jsonStr
                            );
                            log(`âŒ SSE æ•¸æ“šè§£æéŒ¯èª¤: ${parseError.message}`);
                          }
                        }
                      }
                    }

                    // ç¹¼çºŒè®€å–ä¸‹ä¸€å€‹æ•¸æ“šå¡Š
                    readStream();
                  })
                  .catch((error) => {
                    console.error("è®€å–æµéŒ¯èª¤:", error);
                    log(`âŒ è®€å–æµéŒ¯èª¤: ${error.message}`);
                    updateStatus("é€£æ¥éŒ¯èª¤", "error");
                  });
              }

              readStream();
            })
            .catch((error) => {
              console.error("SSE é€£æ¥å¤±æ•—:", error);
              log(`âŒ SSE é€£æ¥å¤±æ•—: ${error.message}`);
              updateStatus("é€£æ¥å¤±æ•—", "error");
            });
        } catch (error) {
          console.error("startSSETest éŒ¯èª¤:", error);
          log(`âŒ æ¸¬è©¦å•Ÿå‹•éŒ¯èª¤: ${error.message}`);
        }
      }

      function handleSSEEvent(data, eventType, eventNumber) {
        try {
          console.log(`è™•ç†äº‹ä»¶ ${eventNumber}:`, eventType, data);
          log(`ğŸ“¨ äº‹ä»¶ ${eventNumber}: ${eventType}`);

          switch (eventType) {
            case "user_message":
              log("ğŸ‘¤ ç”¨æˆ¶æ¶ˆæ¯å·²å‰µå»º");
              break;

            case "assistant_message_created":
              log(`ğŸ¤– AI æ¶ˆæ¯å·²å‰µå»º: ${data.assistant_message_id}`);
              break;

            case "stream_content":
              const contentLen = data.content?.length || 0;
              const thinkingLen = data.thinking_content?.length || 0;
              const deltaLen = data.content_delta?.length || 0;

              log(
                `ğŸ”„ æµå¼å…§å®¹æ›´æ–°: å…§å®¹=${contentLen}å­—ç¬¦, æ€è€ƒ=${thinkingLen}å­—ç¬¦, å¢é‡=${deltaLen}å­—ç¬¦`
              );
              console.log("stream_content è©³æƒ…:", {
                content: data.content,
                content_delta: data.content_delta,
                thinking: data.thinking_content?.substring(0, 100) + "...",
                contentLength: contentLen,
                deltaLength: deltaLen,
                thinkingLength: thinkingLen,
              });

              // è™•ç†æ€è€ƒå…§å®¹ - ä¿®å¾©ï¼šå³æ™‚é¡¯ç¤ºæ€è€ƒå…§å®¹ï¼Œä½¿ç”¨æ‰“å­—æ©Ÿå‹•ç•«
              if (data.thinking_content !== undefined) {
                const newThinkingContent = data.thinking_content;
                const thinkingDelta = data.thinking_delta; // æ–°å¢çš„æ€è€ƒå…§å®¹ç‰‡æ®µ

                // å¦‚æœæœ‰æ€è€ƒå…§å®¹å¢é‡ï¼Œè¨˜éŒ„è©³æƒ…
                if (thinkingDelta) {
                  console.log("ğŸ§  æ”¶åˆ°æ€è€ƒå…§å®¹å¢é‡:", {
                    deltaLength: thinkingDelta.length,
                    deltaPreview: thinkingDelta.substring(0, 50) + "...",
                    totalLength: newThinkingContent.length,
                  });
                }

                // å¦‚æœæ€è€ƒå…§å®¹æœ‰è®ŠåŒ–ï¼Œä½¿ç”¨æ‰“å­—æ©Ÿå‹•ç•«é¡¯ç¤º
                if (newThinkingContent !== thinkingContent) {
                  const currentThinkingContent = thinkingContent;

                  // å¦‚æœæ–°å…§å®¹æ¯”ç•¶å‰å…§å®¹é•·ï¼Œä½¿ç”¨æ‰“å­—æ©Ÿå‹•ç•«
                  if (
                    newThinkingContent.length > currentThinkingContent.length
                  ) {
                    log(
                      `ğŸ§  æº–å‚™æ€è€ƒå…§å®¹æ‰“å­—æ©Ÿå‹•ç•«: ${
                        currentThinkingContent.length
                      } â†’ ${newThinkingContent.length} (+${
                        newThinkingContent.length -
                        currentThinkingContent.length
                      })`
                    );
                    animateThinkingTyping(
                      newThinkingContent,
                      currentThinkingContent
                    );
                    thinkingContent = newThinkingContent;
                  } else {
                    // å¦‚æœå…§å®¹æ²’æœ‰å¢åŠ æˆ–è€…æ˜¯å…¨æ–°çš„å…§å®¹ï¼Œç›´æ¥æ›´æ–°
                    thinkingContent = newThinkingContent;
                    updateThinkingContent(thinkingContent);
                    log(`ğŸ§  æ€è€ƒå…§å®¹ç›´æ¥æ›´æ–°: ${thinkingContent.length} å­—ç¬¦`);
                  }

                  // å¦‚æœæœ‰æ€è€ƒå…§å®¹ï¼Œæ‰“å°è©³æƒ…
                  if (thinkingContent && thinkingContent.length > 0) {
                    console.log("ğŸ§  æ€è€ƒå…§å®¹è©³æƒ…:", {
                      length: thinkingContent.length,
                      preview: thinkingContent.substring(0, 200) + "...",
                    });
                  }
                }
              }

              // è™•ç†æ¶ˆæ¯å…§å®¹ï¼ˆä½¿ç”¨æ‰“å­—æ©Ÿæ•ˆæœï¼‰
              if (data.content !== undefined) {
                const newContent = data.content;
                if (newContent.length > messageContent.length) {
                  log(
                    `ğŸ“ æº–å‚™æ‰“å­—æ©Ÿå‹•ç•«: ${messageContent.length} â†’ ${newContent.length}`
                  );
                  animateTyping(newContent, messageContent);
                  messageContent = newContent;
                } else {
                  messageContent = newContent;
                  updateMessageContent(messageContent);
                }
              }
              break;

            case "thinking_content_processed":
              log("ğŸ§  æ€è€ƒå…§å®¹è™•ç†å®Œæˆ");
              if (data.thinking_content) {
                thinkingContent = data.thinking_content;
                updateThinkingContent(thinkingContent);
              }
              break;

            case "stream_done":
              log("âœ… æµå¼è™•ç†å®Œæˆ");
              updateStatus("æµå¼è™•ç†å®Œæˆ", "connected");
              if (data.full_content) {
                messageContent = data.full_content;
                updateMessageContent(messageContent);
                log(`ğŸ“ æœ€çµ‚å…§å®¹: ${data.full_content.length} å­—ç¬¦`);
              }
              break;

            default:
              log(`â“ æœªçŸ¥äº‹ä»¶é¡å‹: ${eventType}`);
              break;
          }
        } catch (error) {
          console.error("è™•ç† SSE äº‹ä»¶éŒ¯èª¤:", error);
          log(`âŒ è™•ç†äº‹ä»¶éŒ¯èª¤: ${error.message}`);
        }
      }

      function stopSSETest() {
        console.log("stopSSETest è¢«èª¿ç”¨");
        // ç§»é™¤ returnï¼Œè®“å‡½æ•¸æ­£å¸¸åŸ·è¡Œ
        log("ğŸ›‘ åœæ­¢æ¸¬è©¦ï¼ˆåŠŸèƒ½æš«æ™‚ç¦ç”¨ï¼‰");
      }

      function clearLogs() {
        try {
          document.getElementById("log").innerHTML = "";
          console.log("æ—¥èªŒå·²æ¸…é™¤");
        } catch (error) {
          console.error("æ¸…é™¤æ—¥èªŒéŒ¯èª¤:", error);
        }
      }

      // å…¨å±€éŒ¯èª¤è™•ç†
      window.addEventListener("error", (event) => {
        console.error("å…¨å±€éŒ¯èª¤:", event.error);
        log(`âŒ å…¨å±€éŒ¯èª¤: ${event.error?.message || event.message}`);
      });

      // é˜²æ­¢é é¢æ„å¤–é‡è¼‰
      window.addEventListener("beforeunload", (event) => {
        console.log("é é¢å³å°‡å¸è¼‰");
      });
    </script>
  </body>
</html>
